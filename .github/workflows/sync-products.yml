name: Sync Products from Shopify

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Triggers:
#   1. Scheduled â€” every 6 hours (catches most changes quickly)
#   2. Manual    â€” click "Run workflow" in GitHub Actions tab
#   3. Webhook   â€” Shopify â†’ Cloudflare Worker â†’ repository_dispatch (future)
#   4. On push   â€” to scripts/sync-products.py (self-test on code change)
#
# NOTE: GITHUB_TOKEN pushes do NOT trigger other workflows, so
#       we deploy directly here after committing sync changes.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

on:
  schedule:
    - cron: '0 */6 * * *'       # Every 6 hours: 00:00, 06:00, 12:00, 18:00 UTC
  workflow_dispatch:              # Manual trigger from GitHub UI
  repository_dispatch:
    types: [shopify-product-update]   # Future webhook integration
  push:
    paths:
      - 'scripts/sync-products.py'

# Prevent overlapping sync runs (cron fires while previous still running,
# or manual trigger during cron). Cancel the older run.
concurrency:
  group: shopify-sync
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.changes.outputs.changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Sync products from Shopify
        env:
          SHOPIFY_DOMAIN: dbx3hf-qe.myshopify.com
          SHOPIFY_STOREFRONT_TOKEN: ${{ secrets.SHOPIFY_STOREFRONT_TOKEN || '3ed866388b8a983188443f1d808fd561' }}
        run: python scripts/sync-products.py

      - name: Check for changes
        id: changes
        run: |
          git diff --quiet && echo "changed=false" >> $GITHUB_OUTPUT || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "Shopify Sync Bot"
          git config user.email "sync@magnetmomentsco.us"
          
          # Get a quick summary of what changed
          PRODUCT_COUNT=$(python3 -c "import json; d=json.load(open('_data/products.json')); print(d['productCount'])")
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          
          git add -A
          git commit -m "ðŸ”„ Auto-sync: ${PRODUCT_COUNT} products from Shopify

          Synced at ${TIMESTAMP}
          Triggered by: ${{ github.event_name }}"
          
          git push

  # Deploy directly after sync â€” GITHUB_TOKEN pushes don't trigger
  # deploy-pages.yml, so we deploy from here when products change.
  deploy:
    needs: sync
    if: needs.sync.outputs.changed == 'true'
    runs-on: ubuntu-latest
    # Prevent collision with deploy-pages.yml (manual pushes)
    concurrency:
      group: pages
      cancel-in-progress: false
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main    # Get the commit we just pushed

      - name: Inject Firebase config
        env:
          FB_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FB_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FB_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
          FB_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FB_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FB_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FB_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        run: |
          # Replace placeholders in tracker and admin page with real Firebase credentials
          for f in assets/js/mm-tracker.js admin/index.html; do
            [ -f "$f" ] || continue
            sed -i "s|__FIREBASE_API_KEY__|${FB_API_KEY}|g" "$f"
            sed -i "s|__FIREBASE_AUTH_DOMAIN__|${FB_AUTH_DOMAIN}|g" "$f"
            sed -i "s|__FIREBASE_DATABASE_URL__|${FB_DATABASE_URL}|g" "$f"
            sed -i "s|__FIREBASE_PROJECT_ID__|${FB_PROJECT_ID}|g" "$f"
            sed -i "s|__FIREBASE_STORAGE_BUCKET__|${FB_STORAGE_BUCKET}|g" "$f"
            sed -i "s|__FIREBASE_MESSAGING_SENDER_ID__|${FB_MESSAGING_SENDER_ID}|g" "$f"
            sed -i "s|__FIREBASE_APP_ID__|${FB_APP_ID}|g" "$f"
          done
          echo "âœ… Firebase config injected"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
