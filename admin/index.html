<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Command Center â€” Magnet Moments Co.</title>
  <link rel="icon" href="/favicon.ico" sizes="48x48">
  <link rel="icon" href="/assets/images/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png">
  <meta name="theme-color" content="#1a1a2e">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <style>
    /* â”€â”€â”€ Reset & Base â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #1a1a2e;
      --bg-card: #16213e;
      --bg-card-hover: #1a2747;
      --bg-surface: #0f3460;
      --text: #e0e0e0;
      --text-muted: #8899aa;
      --text-dim: #556677;
      --pink: #C77D8A;
      --green: #7A9D54;
      --gold: #D4A574;
      --cream: #FFF8F0;
      --red: #e74c3c;
      --yellow: #f1c40f;
      --blue: #3498db;
      --purple: #9b59b6;
      --border: #1e3a5f;
      --radius: 12px;
      --shadow: 0 4px 24px rgba(0,0,0,0.3);
    }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }
    h1, h2, h3, h4 { font-family: 'Playfair Display', Georgia, serif; font-weight: 600; }
    a { color: var(--pink); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* â”€â”€â”€ Auth Overlay â”€â”€â”€ */
    #auth-overlay {
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(10, 10, 25, 0.97);
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(8px);
    }
    #auth-overlay.hidden { display: none; }
    .auth-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 48px 40px;
      max-width: 420px; width: 90%;
      text-align: center;
      box-shadow: var(--shadow);
    }
    .auth-card .logo { font-size: 48px; margin-bottom: 8px; }
    .auth-card h2 { color: var(--cream); margin-bottom: 4px; font-size: 1.5rem; }
    .auth-card p { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 24px; }
    .btn-google {
      display: inline-flex; align-items: center; gap: 12px;
      width: 100%; padding: 14px 20px;
      background: #fff; color: #333; border: none;
      border-radius: 8px; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: box-shadow 0.2s, transform 0.1s;
      justify-content: center;
    }
    .btn-google:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.3); transform: translateY(-1px); }
    .btn-google:active { transform: translateY(0); }
    .btn-google svg { width: 20px; height: 20px; flex-shrink: 0; }
    .auth-error { color: var(--red); font-size: 0.85rem; margin-top: 16px; display: none; }
    .auth-loading { color: var(--text-muted); font-size: 0.9rem; margin-top: 16px; display: none; }
    .auth-user {
      display: flex; align-items: center; gap: 10px;
      color: var(--text-muted); font-size: 0.85rem;
    }
    .auth-user img {
      width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--border);
    }

    /* â”€â”€â”€ Top Bar â”€â”€â”€ */
    .topbar {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 12px;
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
    }
    .topbar-left { display: flex; align-items: center; gap: 12px; }
    .topbar-logo { font-family: 'Playfair Display', serif; font-size: 1.25rem; font-weight: 700; color: var(--cream); }
    .topbar-logo span { font-size: 1.3rem; }
    .topbar-right { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
    .live-badge {
      display: flex; align-items: center; gap: 6px;
      background: rgba(122, 157, 84, 0.15); border: 1px solid rgba(122, 157, 84, 0.3);
      padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; color: var(--green);
    }
    .live-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .topbar-date { color: var(--text-muted); font-size: 0.85rem; }
    .btn-logout {
      background: transparent; border: 1px solid var(--border); color: var(--text-muted);
      padding: 6px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85rem;
      transition: all 0.2s;
    }
    .btn-logout:hover { border-color: var(--red); color: var(--red); }

    /* â”€â”€â”€ Main Layout â”€â”€â”€ */
    .dashboard { max-width: 1400px; margin: 0 auto; padding: 24px; }

    /* â”€â”€â”€ Quick Stats â”€â”€â”€ */
    .stats-row {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px; margin-bottom: 24px;
    }
    .stat-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px 24px;
      box-shadow: var(--shadow); transition: transform 0.2s, border-color 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); border-color: var(--pink); }
    .stat-card .stat-icon { font-size: 1.5rem; margin-bottom: 6px; }
    .stat-card .stat-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .stat-value { font-size: 2rem; font-weight: 700; color: var(--cream); margin: 4px 0; font-family: 'Inter', sans-serif; }
    .stat-card .stat-sub { font-size: 0.8rem; color: var(--text-dim); }

    /* â”€â”€â”€ Sections â”€â”€â”€ */
    .section {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius); margin-bottom: 20px;
      box-shadow: var(--shadow); overflow: hidden;
    }
    .section-header {
      padding: 18px 24px;
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer; user-select: none;
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(15, 52, 96, 0.3) 100%);
      border-bottom: 1px solid transparent;
      transition: background 0.2s;
    }
    .section-header:hover { background: var(--bg-card-hover); }
    .section-header h3 {
      font-size: 1.1rem; color: var(--cream); display: flex; align-items: center; gap: 10px;
    }
    .section-header .badge {
      background: var(--red); color: #fff; font-size: 0.7rem; font-family: 'Inter', sans-serif;
      padding: 2px 8px; border-radius: 10px; font-weight: 600;
    }
    .section-toggle {
      font-size: 1.2rem; color: var(--text-muted); transition: transform 0.3s;
    }
    .section.collapsed .section-toggle { transform: rotate(-90deg); }
    .section-body { padding: 24px; }
    .section.collapsed .section-body { display: none; }
    .section.collapsed .section-header { border-bottom: none; }
    .section-header.open { border-bottom: 1px solid var(--border); }

    /* â”€â”€â”€ Loading State â”€â”€â”€ */
    .loading {
      text-align: center; padding: 32px; color: var(--text-muted);
      font-size: 0.9rem;
    }
    .loading::before { content: 'â³ '; }
    .spinner {
      display: inline-block; width: 20px; height: 20px;
      border: 2px solid var(--border); border-top-color: var(--pink);
      border-radius: 50%; animation: spin 0.8s linear infinite;
      margin-right: 8px; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€â”€ Firebase Warning â”€â”€â”€ */
    .firebase-warning {
      background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.3);
      border-radius: 8px; padding: 20px; margin-bottom: 20px;
      color: var(--red); text-align: center;
    }
    .firebase-warning code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-size: 0.85rem; }

    /* â”€â”€â”€ Tables â”€â”€â”€ */
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .data-table th {
      text-align: left; padding: 10px 14px; color: var(--text-muted);
      border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.75rem;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .data-table td {
      padding: 10px 14px; border-bottom: 1px solid rgba(30, 58, 95, 0.5);
      vertical-align: middle;
    }
    .data-table tr:hover td { background: rgba(199, 125, 138, 0.05); }
    .data-table .truncate { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* â”€â”€â”€ Charts â”€â”€â”€ */
    .chart-container { position: relative; width: 100%; max-height: 350px; margin: 16px 0; }
    .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .chart-col { min-width: 0; }

    /* â”€â”€â”€ Funnel â”€â”€â”€ */
    .funnel-bar {
      display: flex; align-items: center; gap: 12px; margin-bottom: 8px;
    }
    .funnel-label { width: 160px; font-size: 0.85rem; text-align: right; color: var(--text-muted); flex-shrink: 0; }
    .funnel-track { flex: 1; background: rgba(255,255,255,0.05); border-radius: 6px; height: 32px; overflow: hidden; }
    .funnel-fill {
      height: 100%; border-radius: 6px; display: flex; align-items: center;
      padding: 0 12px; font-size: 0.8rem; font-weight: 600; color: #fff;
      transition: width 0.8s ease;
    }

    /* â”€â”€â”€ Gauge Cards â”€â”€â”€ */
    .gauge-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .gauge-card {
      background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
      padding: 20px; text-align: center;
    }
    .gauge-card .gauge-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .gauge-card .gauge-value { font-size: 2rem; font-weight: 700; margin: 8px 0; font-family: 'Inter', sans-serif; }
    .gauge-card .gauge-unit { font-size: 0.8rem; color: var(--text-dim); }
    .gauge-card.green .gauge-value { color: var(--green); }
    .gauge-card.yellow .gauge-value { color: var(--yellow); }
    .gauge-card.red .gauge-value { color: var(--red); }

    /* â”€â”€â”€ SEO Table â”€â”€â”€ */
    .seo-pass { color: var(--green); }
    .seo-fail { color: var(--red); }
    .seo-score { font-weight: 700; }

    /* â”€â”€â”€ Quick Links Grid â”€â”€â”€ */
    .links-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .link-card {
      background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
      padding: 16px 20px; display: flex; align-items: center; gap: 12px;
      transition: all 0.2s; text-decoration: none;
    }
    .link-card:hover { border-color: var(--pink); transform: translateY(-2px); text-decoration: none; }
    .link-card .link-icon { font-size: 1.5rem; }
    .link-card .link-info { flex: 1; }
    .link-card .link-title { font-size: 0.9rem; font-weight: 600; color: var(--cream); }
    .link-card .link-url { font-size: 0.75rem; color: var(--text-dim); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .link-card .link-arrow { color: var(--text-dim); font-size: 1.2rem; }

    /* â”€â”€â”€ Newsletter Cards â”€â”€â”€ */
    .nl-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .nl-card { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center; }
    .nl-card .nl-val { font-size: 1.5rem; font-weight: 700; color: var(--cream); font-family: 'Inter', sans-serif; }
    .nl-card .nl-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; }

    /* â”€â”€â”€ Social Proof Config â”€â”€â”€ */
    .config-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 0; border-bottom: 1px solid rgba(30, 58, 95, 0.5);
    }
    .config-row:last-child { border-bottom: none; }
    .config-label { font-size: 0.9rem; }
    .config-label small { display: block; color: var(--text-dim); font-size: 0.78rem; }
    .toggle-switch {
      position: relative; width: 48px; height: 26px; cursor: pointer;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; inset: 0; background: var(--border); border-radius: 13px;
      transition: 0.3s;
    }
    .toggle-slider::before {
      content: ''; position: absolute; width: 20px; height: 20px;
      left: 3px; bottom: 3px; background: var(--text-muted);
      border-radius: 50%; transition: 0.3s;
    }
    .toggle-switch input:checked + .toggle-slider { background: var(--green); }
    .toggle-switch input:checked + .toggle-slider::before { transform: translateX(22px); background: #fff; }

    input[type="number"].config-input {
      background: var(--bg); color: var(--text); border: 1px solid var(--border);
      border-radius: 6px; padding: 6px 10px; width: 80px; font-size: 0.85rem;
    }

    /* â”€â”€â”€ Digest Textarea â”€â”€â”€ */
    .digest-area {
      width: 100%; min-height: 300px; background: var(--bg); color: var(--text);
      border: 1px solid var(--border); border-radius: 8px; padding: 16px;
      font-family: 'Inter', monospace; font-size: 0.85rem; resize: vertical;
    }
    .btn {
      padding: 10px 24px; border: none; border-radius: 8px; font-size: 0.9rem;
      font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .btn-primary { background: var(--pink); color: #fff; }
    .btn-primary:hover { background: #b06a77; }
    .btn-secondary { background: var(--bg-surface); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--pink); }
    .btn-sm { padding: 6px 14px; font-size: 0.8rem; }

    /* â”€â”€â”€ Filters â”€â”€â”€ */
    .filter-bar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
    .filter-bar select, .filter-bar input[type="text"] {
      background: var(--bg); color: var(--text); border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 14px; font-size: 0.85rem;
    }
    .filter-bar input[type="text"] { flex: 1; min-width: 200px; }
    .filter-bar input[type="text"]::placeholder { color: var(--text-dim); }

    /* â”€â”€â”€ Product Thumbnails â”€â”€â”€ */
    .prod-thumb {
      width: 48px; height: 48px; border-radius: 6px; object-fit: cover;
      background: var(--bg); border: 1px solid var(--border);
    }

    /* â”€â”€â”€ Status Badges â”€â”€â”€ */
    .status-badge {
      display: inline-block; padding: 3px 10px; border-radius: 12px;
      font-size: 0.75rem; font-weight: 600;
    }
    .status-badge.success { background: rgba(122, 157, 84, 0.15); color: var(--green); }
    .status-badge.failure { background: rgba(231, 76, 60, 0.15); color: var(--red); }
    .status-badge.in-stock { background: rgba(122, 157, 84, 0.15); color: var(--green); }
    .status-badge.out-of-stock { background: rgba(231, 76, 60, 0.15); color: var(--red); }

    /* â”€â”€â”€ Responsive â”€â”€â”€ */
    @media (max-width: 768px) {
      .dashboard { padding: 12px; }
      .topbar { padding: 10px 14px; }
      .topbar-logo { font-size: 1rem; }
      .chart-row { grid-template-columns: 1fr; }
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .section-body { padding: 16px; }
      .data-table { font-size: 0.78rem; }
      .data-table th, .data-table td { padding: 8px 10px; }
      .funnel-label { width: 100px; font-size: 0.78rem; }
      .links-grid { grid-template-columns: 1fr; }
      .nl-stats { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px) {
      .stats-row { grid-template-columns: 1fr; }
      .stat-card .stat-value { font-size: 1.5rem; }
      .gauge-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* â”€â”€â”€ Scrollbar â”€â”€â”€ */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

    /* â”€â”€â”€ Table overflow â”€â”€â”€ */
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }

    /* â”€â”€â”€ Utility â”€â”€â”€ */
    .mt-16 { margin-top: 16px; }
    .mb-16 { margin-bottom: 16px; }
    .text-center { text-align: center; }
    .text-muted { color: var(--text-muted); }
    .flex-between { display: flex; align-items: center; justify-content: space-between; }
    .gap-12 { gap: 12px; }

    /* â”€â”€â”€ Session Recordings â”€â”€â”€ */
    .session-list { display: flex; flex-direction: column; gap: 10px; }
    .session-card {
      background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
      padding: 16px 20px; display: flex; align-items: center; gap: 16px;
      transition: border-color 0.2s;
    }
    .session-card:hover { border-color: var(--pink); }
    .session-meta { flex: 1; display: flex; flex-wrap: wrap; gap: 16px; align-items: center; }
    .session-meta .sm-item { font-size: 0.85rem; }
    .session-meta .sm-label { color: var(--text-dim); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.3px; }
    .session-meta .sm-val { color: var(--cream); font-weight: 600; }
    .session-timeline { margin-top: 12px; padding: 12px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; }
    .session-timeline .tl-event { display: flex; gap: 10px; padding: 4px 0; font-size: 0.82rem; color: var(--text-muted); }
    .session-timeline .tl-time { color: var(--text-dim); flex-shrink: 0; width: 60px; }

    /* â”€â”€â”€ A/B Testing â”€â”€â”€ */
    .ab-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
    .ab-card {
      background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
      padding: 20px; transition: border-color 0.2s;
    }
    .ab-card:hover { border-color: var(--gold); }
    .ab-name { font-size: 1rem; font-weight: 600; color: var(--cream); margin-bottom: 12px; }
    .ab-variants { display: flex; gap: 12px; }
    .ab-variant {
      flex: 1; background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 8px; padding: 12px; text-align: center;
    }
    .ab-variant-label { font-size: 0.78rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .ab-variant-value { font-size: 1.5rem; font-weight: 700; font-family: 'Inter', sans-serif; margin: 4px 0; }
    .ab-variant-value.a { color: var(--green); }
    .ab-variant-value.b { color: var(--pink); }
    .ab-winner { font-size: 0.78rem; color: var(--gold); font-weight: 600; margin-top: 8px; }
    .ab-input-row { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    .ab-input-row input[type="text"] {
      background: var(--bg); color: var(--text); border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 14px; font-size: 0.85rem; flex: 1; min-width: 200px;
    }
    .ab-input-row input::placeholder { color: var(--text-dim); }

    /* â”€â”€â”€ Revenue Estimator â”€â”€â”€ */
    .rev-inputs {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px; margin-bottom: 20px;
    }
    .rev-input-card {
      background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px;
    }
    .rev-input-card label { display: block; font-size: 0.78rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px; }
    .rev-input-card input {
      width: 100%; background: var(--bg-card); color: var(--cream); border: 1px solid var(--border);
      border-radius: 6px; padding: 10px 14px; font-size: 1.1rem; font-weight: 600;
      font-family: 'Inter', sans-serif;
    }
    .rev-results { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; }
    .rev-card {
      background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
      padding: 20px; text-align: center;
    }
    .rev-card .rev-label { font-size: 0.78rem; color: var(--text-muted); text-transform: uppercase; }
    .rev-card .rev-value { font-size: 1.8rem; font-weight: 700; font-family: 'Inter', sans-serif; margin: 6px 0; }
    .rev-card .rev-sub { font-size: 0.78rem; color: var(--text-dim); }

    /* â”€â”€â”€ Quick Actions â”€â”€â”€ */
    .actions-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    .action-card {
      background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
      padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s;
    }
    .action-card:hover { border-color: var(--pink); transform: translateY(-2px); }
    .action-card.running { border-color: var(--gold); opacity: 0.7; pointer-events: none; }
    .action-card .action-icon { font-size: 2rem; margin-bottom: 8px; }
    .action-card .action-title { font-size: 0.9rem; font-weight: 600; color: var(--cream); }
    .action-card .action-desc { font-size: 0.78rem; color: var(--text-dim); margin-top: 4px; }
    .action-card .action-status { font-size: 0.78rem; margin-top: 8px; font-weight: 600; }
    .action-card .action-status.success { color: var(--green); }
    .action-card .action-status.error { color: var(--red); }

    /* â”€â”€â”€ Storage Manager â”€â”€â”€ */
    .storage-gauge-wrap {
      display: flex; flex-direction: column; align-items: center; margin-bottom: 24px;
    }
    .storage-gauge {
      width: 100%; max-width: 500px; height: 32px; background: var(--bg);
      border: 1px solid var(--border); border-radius: 16px; overflow: hidden;
      position: relative;
    }
    .storage-gauge-fill {
      height: 100%; border-radius: 16px; transition: width 0.8s ease;
      display: flex; align-items: center; justify-content: flex-end;
      padding-right: 12px; font-size: 0.78rem; font-weight: 600; color: #fff;
      min-width: 40px;
    }
    .storage-gauge-fill.green { background: linear-gradient(90deg, #7A9D54, #5a8a30); }
    .storage-gauge-fill.yellow { background: linear-gradient(90deg, #D4A574, #c08530); }
    .storage-gauge-fill.red { background: linear-gradient(90deg, #e74c3c, #c0392b); }
    .storage-labels { display: flex; justify-content: space-between; width: 100%; max-width: 500px; margin-top: 6px; font-size: 0.78rem; color: var(--text-dim); }
    .storage-breakdown { margin-top: 20px; }
    .storage-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0; border-bottom: 1px solid rgba(30, 58, 95, 0.5);
    }
    .storage-row:last-child { border-bottom: none; }
    .storage-row .sr-path { font-size: 0.9rem; font-weight: 500; }
    .storage-row .sr-size { font-size: 0.85rem; color: var(--text-muted); font-family: 'Inter', monospace; }
    .storage-row .sr-actions { display: flex; gap: 6px; }
    .btn-danger { background: rgba(231,76,60,0.15); color: var(--red); border: 1px solid rgba(231,76,60,0.3); }
    .btn-danger:hover { background: rgba(231,76,60,0.3); }
    .autoprune-bar {
      display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
      margin-top: 16px; padding: 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px;
    }
    .autoprune-bar label { font-size: 0.85rem; color: var(--text-muted); }
    .autoprune-bar select, .autoprune-bar input[type="number"] {
      background: var(--bg-card); color: var(--text); border: 1px solid var(--border);
      border-radius: 6px; padding: 6px 10px; font-size: 0.85rem;
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- GOOGLE AUTH OVERLAY                                                    -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-overlay">
  <div class="auth-card">
    <div class="logo">âš™ï¸</div>
    <h2>Command Center</h2>
    <p>Magnet Moments Co. â€” Admin Dashboard</p>
    <button id="btn-google-signin" class="btn-google">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </button>
    <div class="auth-loading" id="auth-loading"><span class="spinner"></span> Signing in...</div>
    <div class="auth-error" id="auth-error"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- MAIN DASHBOARD (hidden until authenticated)                            -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" style="display:none;">

  <!-- â”€â”€â”€ Top Bar â”€â”€â”€ -->
  <header class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo"><span>âš™ï¸</span> Command Center</div>
    </div>
    <div class="topbar-right">
      <div class="live-badge">
        <div class="live-dot"></div>
        <span id="live-count">0 visitors online</span>
      </div>
      <div class="topbar-date" id="topbar-date"></div>
      <button class="btn-logout" id="btn-logout">Logout</button>
    </div>
  </header>

  <main class="dashboard">

    <!-- â”€â”€â”€ Firebase Warning (hidden by default) â”€â”€â”€ -->
    <div class="firebase-warning" id="firebase-warning" style="display:none;">
      <strong>âš ï¸ Firebase Not Configured</strong>
      <p style="margin-top:8px;">Analytics data is unavailable. Update the Firebase config in <code>mm-tracker.js</code> and this dashboard with your real credentials.</p>
    </div>

    <!-- â”€â”€â”€ Quick Stats Row â”€â”€â”€ -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘</div>
        <div class="stat-label">Today's Visitors</div>
        <div class="stat-value" id="stat-visitors">â€”</div>
        <div class="stat-sub" id="stat-visitors-sub">Loadingâ€¦</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ“¦</div>
        <div class="stat-label">Total Products</div>
        <div class="stat-value" id="stat-products">â€”</div>
        <div class="stat-sub" id="stat-products-sub">Loadingâ€¦</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ•</div>
        <div class="stat-label">Last Sync</div>
        <div class="stat-value" id="stat-sync" style="font-size:1.2rem;">â€”</div>
        <div class="stat-sub" id="stat-sync-sub">Product data</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸš€</div>
        <div class="stat-label">Last Deploy</div>
        <div class="stat-value" id="stat-deploy" style="font-size:1.2rem;">â€”</div>
        <div class="stat-sub" id="stat-deploy-sub">GitHub Actions</div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Live Visitors â•â•â• -->
    <div class="section" id="section-live-visitors">
      <div class="section-header open" onclick="toggleSection('section-live-visitors')">
        <h3>ğŸ‘¥ Live Visitors</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div id="live-visitors-content"><div class="loading">Connecting to real-time dataâ€¦</div></div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Traffic Overview â•â•â• -->
    <div class="section" id="section-traffic">
      <div class="section-header open" onclick="toggleSection('section-traffic')">
        <h3>ğŸ“ˆ Traffic Overview</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="chart-container"><canvas id="chart-traffic"></canvas></div>
        <div class="chart-row mt-16">
          <div class="chart-col">
            <h4 style="font-size:0.95rem;color:var(--text-muted);margin-bottom:10px;">Top 5 Pages Today</h4>
            <div id="top-pages"><div class="loading">Loadingâ€¦</div></div>
          </div>
          <div class="chart-col">
            <h4 style="font-size:0.95rem;color:var(--text-muted);margin-bottom:10px;">Top 5 Referrers Today</h4>
            <div id="top-referrers"><div class="loading">Loadingâ€¦</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Traffic Sources â•â•â• -->
    <div class="section" id="section-traffic-sources">
      <div class="section-header open" onclick="toggleSection('section-traffic-sources')">
        <h3>ğŸŒ Traffic Sources</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="chart-row">
          <div class="chart-col" style="max-width:400px;margin:0 auto;">
            <div class="chart-container"><canvas id="chart-sources"></canvas></div>
          </div>
          <div class="chart-col" id="sources-breakdown"><div class="loading">Loadingâ€¦</div></div>
        </div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Scroll Depth â•â•â• -->
    <div class="section" id="section-scroll-depth">
      <div class="section-header open" onclick="toggleSection('section-scroll-depth')">
        <h3>ğŸ“œ Scroll Depth</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="chart-container"><canvas id="chart-scroll"></canvas></div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Click Heatmap â•â•â• -->
    <div class="section" id="section-click-heatmap">
      <div class="section-header open" onclick="toggleSection('section-click-heatmap')">
        <h3>ğŸ–±ï¸ Click Heatmap</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="filter-bar">
          <select id="heatmap-page-select"><option value="">Select a pageâ€¦</option></select>
          <button class="btn btn-sm btn-secondary" onclick="loadClickHeatmap()">Load</button>
        </div>
        <div class="chart-container"><canvas id="chart-clicks"></canvas></div>
        <h4 style="font-size:0.95rem;color:var(--text-muted);margin:16px 0 10px;">Rage Clicks</h4>
        <div id="rage-clicks-content" class="table-wrap"><div class="loading">Select a page to load dataâ€¦</div></div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Product Engagement Funnel â•â•â• -->
    <div class="section" id="section-funnel">
      <div class="section-header open" onclick="toggleSection('section-funnel')">
        <h3>ğŸ”„ Product Engagement Funnel</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div id="funnel-bars"><div class="loading">Loadingâ€¦</div></div>
        <h4 style="font-size:0.95rem;color:var(--text-muted);margin:20px 0 10px;">Per-Product Breakdown</h4>
        <div id="funnel-table" class="table-wrap"><div class="loading">Loadingâ€¦</div></div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Newsletter Popup â•â•â• -->
    <div class="section" id="section-newsletter">
      <div class="section-header open" onclick="toggleSection('section-newsletter')">
        <h3>ğŸ’Œ Newsletter Popup</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="nl-stats" id="nl-stats"><div class="loading" style="grid-column:1/-1;">Loadingâ€¦</div></div>
        <div class="chart-row mt-16">
          <div class="chart-col">
            <div class="chart-container"><canvas id="chart-newsletter-trend"></canvas></div>
          </div>
          <div class="chart-col" style="max-width:350px;margin:0 auto;">
            <div class="chart-container"><canvas id="chart-newsletter-dismiss"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Visitor Intent â•â•â• -->
    <div class="section" id="section-intent">
      <div class="section-header open" onclick="toggleSection('section-intent')">
        <h3>ğŸ¯ Visitor Intent</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="chart-row">
          <div class="chart-col" style="max-width:350px;margin:0 auto;">
            <div class="chart-container"><canvas id="chart-intent"></canvas></div>
          </div>
          <div class="chart-col" id="intent-details"><div class="loading">Loadingâ€¦</div></div>
        </div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Cart Analytics â•â•â• -->
    <div class="section" id="section-cart">
      <div class="section-header open" onclick="toggleSection('section-cart')">
        <h3>ğŸ›’ Cart Analytics</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="chart-row">
          <div class="chart-col">
            <h4 style="font-size:0.95rem;color:var(--text-muted);margin-bottom:10px;">Top Products Added to Cart</h4>
            <div class="chart-container"><canvas id="chart-cart-products"></canvas></div>
          </div>
          <div class="chart-col">
            <h4 style="font-size:0.95rem;color:var(--text-muted);margin-bottom:10px;">Cart Additions by Hour</h4>
            <div class="chart-container"><canvas id="chart-cart-hours"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Performance Metrics â•â•â• -->
    <div class="section" id="section-performance">
      <div class="section-header open" onclick="toggleSection('section-performance')">
        <h3>âš¡ Performance Metrics</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="gauge-grid" id="perf-gauges"><div class="loading" style="grid-column:1/-1;">Loadingâ€¦</div></div>
        <div class="chart-row mt-16">
          <div class="chart-col" style="max-width:350px;margin:0 auto;">
            <h4 style="font-size:0.95rem;color:var(--text-muted);margin-bottom:10px;">Device Breakdown</h4>
            <div class="chart-container"><canvas id="chart-devices"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• SECTION: SEO Health â•â•â• -->
    <div class="section" id="section-seo">
      <div class="section-header open" onclick="toggleSection('section-seo')">
        <h3>ğŸ” SEO Health</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div id="seo-table" class="table-wrap"><div class="loading">Auditing pagesâ€¦</div></div>
        <div class="mt-16" style="display:flex;gap:10px;flex-wrap:wrap;">
          <a href="https://pagespeed.web.dev/analysis?url=https://magnetmomentsco.us" target="_blank" class="btn btn-sm btn-secondary">PageSpeed Insights â†—</a>
          <a href="https://developers.facebook.com/tools/debug/?q=https://magnetmomentsco.us" target="_blank" class="btn btn-sm btn-secondary">Facebook Debugger â†—</a>
          <a href="https://search.google.com/test/rich-results?url=https://magnetmomentsco.us" target="_blank" class="btn btn-sm btn-secondary">Rich Results Test â†—</a>
        </div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Error Log â•â•â• -->
    <div class="section" id="section-errors">
      <div class="section-header open" onclick="toggleSection('section-errors')">
        <h3>ğŸ› Error Log <span class="badge" id="error-badge" style="display:none;">0</span></h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div id="errors-content" class="table-wrap"><div class="loading">Loadingâ€¦</div></div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Social Proof Config â•â•â• -->
    <div class="section" id="section-social-proof">
      <div class="section-header open" onclick="toggleSection('section-social-proof')">
        <h3>ğŸ·ï¸ Social Proof Config</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div id="social-proof-content">
          <div class="config-row">
            <div class="config-label">
              Enable Social Proof Badges
              <small>Show "X people viewed today" badges on product cards</small>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="sp-enabled" onchange="saveSocialProofConfig()">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="config-row">
            <div class="config-label">
              Minimum Views Threshold
              <small>Only show badge when a product has at least this many views</small>
            </div>
            <input type="number" class="config-input" id="sp-threshold" value="5" min="1" max="100" onchange="saveSocialProofConfig()">
          </div>
          <div class="config-row">
            <div class="config-label">
              Badge Style
              <small>How the badge appears on product cards</small>
            </div>
            <select id="sp-style" style="background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:0.85rem;" onchange="saveSocialProofConfig()">
              <option value="subtle">Subtle</option>
              <option value="bold">Bold</option>
              <option value="animated">Animated</option>
            </select>
          </div>
          <h4 style="font-size:0.95rem;color:var(--text-muted);margin:20px 0 10px;">Badge Preview</h4>
          <div id="sp-preview"><div class="loading">Loading product dataâ€¦</div></div>
        </div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Weekly Digest Generator â•â•â• -->
    <div class="section" id="section-digest">
      <div class="section-header open" onclick="toggleSection('section-digest')">
        <h3>ğŸ“Š Weekly Digest Generator</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:16px;">Generate a plain-text summary of the last 7 days of analytics data.</p>
        <button class="btn btn-primary" id="btn-digest" onclick="generateDigest()">Generate Report</button>
        <button class="btn btn-secondary" style="margin-left:8px;" onclick="copyDigest()">Copy to Clipboard</button>
        <textarea class="digest-area mt-16" id="digest-output" placeholder="Click 'Generate Report' to create a weekly summaryâ€¦" readonly></textarea>
      </div>
    </div>

    <!-- â•â•â• SECTION: Quick Links â•â•â• -->
    <div class="section" id="section-links">
      <div class="section-header open" onclick="toggleSection('section-links')">
        <h3>ğŸ”— Quick Links</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="links-grid" id="quick-links-grid"></div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Deployment History â•â•â• -->
    <div class="section" id="section-deploys">
      <div class="section-header open" onclick="toggleSection('section-deploys')">
        <h3>ğŸš¢ Deployment History</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div id="deploys-content" class="table-wrap"><div class="loading">Loadingâ€¦</div></div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Product Inventory â•â•â• -->
    <div class="section" id="section-inventory">
      <div class="section-header open" onclick="toggleSection('section-inventory')">
        <h3>ğŸ“‹ Product Inventory</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="filter-bar">
          <select id="inv-filter" onchange="renderInventory()">
            <option value="all">All Products</option>
            <option value="in-stock">In Stock</option>
            <option value="out-of-stock">Out of Stock</option>
          </select>
          <input type="text" id="inv-search" placeholder="Search productsâ€¦" oninput="renderInventory()">
        </div>
        <div id="inventory-content" class="table-wrap"><div class="loading">Loadingâ€¦</div></div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Session Recordings â•â•â• -->
    <div class="section collapsed" id="section-sessions">
      <div class="section-header" onclick="toggleSection('section-sessions')">
        <h3>ğŸ¥ Session Recordings</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="filter-bar">
          <select id="session-date-select" onchange="renderSessions()">
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
          </select>
          <select id="session-sort" onchange="renderSessions()">
            <option value="duration">Sort by Duration</option>
            <option value="pages">Sort by Pages</option>
            <option value="recent">Most Recent</option>
          </select>
        </div>
        <div id="sessions-stats" class="nl-stats" style="margin-bottom:16px;"><div class="loading" style="grid-column:1/-1;">Loadingâ€¦</div></div>
        <div id="sessions-content"><div class="loading">Loading session dataâ€¦</div></div>
      </div>
    </div>

    <!-- â•â•â• SECTION: A/B Testing â•â•â• -->
    <div class="section collapsed" id="section-ab-testing">
      <div class="section-header" onclick="toggleSection('section-ab-testing')">
        <h3>ğŸ§ª A/B Testing</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="ab-input-row">
          <input type="text" id="ab-new-name" placeholder="Enter experiment name (e.g. hero-cta-color)â€¦">
          <button class="btn btn-primary btn-sm" onclick="addExperiment()">+ Add Experiment</button>
        </div>
        <p style="color:var(--text-dim);font-size:0.78rem;margin-bottom:16px;">Active experiments are stored in localStorage. The tracker auto-assigns visitors to A/B variants using consistent hashing.</p>
        <div id="ab-active-list" style="margin-bottom:20px;"></div>
        <h4 style="font-size:0.95rem;color:var(--text-muted);margin:20px 0 10px;">Experiment Results (from Firebase)</h4>
        <div id="ab-results"><div class="loading">Loading experiment dataâ€¦</div></div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Revenue Estimator â•â•â• -->
    <div class="section collapsed" id="section-revenue">
      <div class="section-header" onclick="toggleSection('section-revenue')">
        <h3>ğŸ’° Revenue Estimator</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:16px;">Estimate potential revenue based on your traffic data and business metrics.</p>
        <div class="rev-inputs">
          <div class="rev-input-card">
            <label>Conversion Rate (%)</label>
            <input type="number" id="rev-conv-rate" value="2.5" min="0" max="100" step="0.1" oninput="calculateRevenue()">
          </div>
          <div class="rev-input-card">
            <label>Average Order Value ($)</label>
            <input type="number" id="rev-aov" value="35" min="0" step="1" oninput="calculateRevenue()">
          </div>
          <div class="rev-input-card">
            <label>Repeat Customer Rate (%)</label>
            <input type="number" id="rev-repeat" value="15" min="0" max="100" step="1" oninput="calculateRevenue()">
          </div>
        </div>
        <div class="rev-results" id="rev-results"><div class="loading" style="grid-column:1/-1;">Loading traffic dataâ€¦</div></div>
        <div class="chart-container mt-16"><canvas id="chart-revenue"></canvas></div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Quick Actions â•â•â• -->
    <div class="section" id="section-actions">
      <div class="section-header open" onclick="toggleSection('section-actions')">
        <h3>âš¡ Quick Actions</h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="actions-grid" id="actions-grid"></div>
        <div id="action-log" style="margin-top:16px;font-size:0.82rem;color:var(--text-dim);max-height:120px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- â•â•â• SECTION: Database Storage Manager â•â•â• -->
    <div class="section" id="section-storage">
      <div class="section-header open" onclick="toggleSection('section-storage')">
        <h3>ğŸ’¾ Database Storage Manager <span class="badge" id="storage-badge" style="display:none;">!</span></h3>
        <span class="section-toggle">â–¼</span>
      </div>
      <div class="section-body">
        <div class="storage-gauge-wrap">
          <div class="storage-gauge"><div class="storage-gauge-fill green" id="storage-fill" style="width:0%;">0%</div></div>
          <div class="storage-labels"><span>0 MB</span><span id="storage-total">â€” / 1,024 MB</span><span>1,024 MB</span></div>
        </div>
        <div id="storage-alert" style="display:none;" class="firebase-warning" role="alert"></div>
        <h4 style="font-size:0.95rem;color:var(--text-muted);margin-bottom:12px;">Data Breakdown by Path</h4>
        <div id="storage-breakdown"><div class="loading">Estimating storage usageâ€¦</div></div>
        <div class="autoprune-bar">
          <label>ğŸ”„ Auto-Prune: Delete data older than</label>
          <input type="number" id="prune-days" value="30" min="1" max="365" style="width:70px;">
          <label>days</label>
          <label class="toggle-switch">
            <input type="checkbox" id="prune-enabled" onchange="saveAutoprune()">
            <span class="toggle-slider"></span>
          </label>
          <button class="btn btn-sm btn-danger" onclick="runManualPrune()" id="btn-prune">Prune Now</button>
          <span id="prune-status" style="font-size:0.82rem;color:var(--text-dim);"></span>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- FIREBASE SDK (compat v9)                                               -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAGNET MOMENTS CO. â€” COMMAND CENTER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
'use strict';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1. GOOGLE AUTHENTICATION
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/* Whitelisted admin emails â€” only these can access the dashboard */
const ADMIN_EMAILS = [
  'alyssa.magnetmomentsco@gmail.com',
  'ajayadesign@gmail.com'
];

let currentUser = null;

function isAdminEmail(email) {
  return ADMIN_EMAILS.includes((email || '').toLowerCase());
}

function showApp(user) {
  currentUser = user;
  document.getElementById('auth-overlay').classList.add('hidden');
  document.getElementById('app').style.display = '';

  // Update logout button to show user info
  const logoutBtn = document.getElementById('btn-logout');
  if (user && user.photoURL) {
    logoutBtn.innerHTML = '<span class="auth-user"><img src="' + user.photoURL + '" alt=""> Sign Out</span>';
  } else {
    logoutBtn.textContent = 'Sign Out';
  }

  initDashboard();
}

function showError(msg) {
  const errEl = document.getElementById('auth-error');
  errEl.textContent = msg;
  errEl.style.display = 'block';
  document.getElementById('auth-loading').style.display = 'none';
  document.getElementById('btn-google-signin').style.display = '';
  setTimeout(() => { errEl.style.display = 'none'; }, 5000);
}

function logout() {
  if (typeof firebase !== 'undefined' && firebase.auth) {
    firebase.auth().signOut().then(() => location.reload());
  } else {
    location.reload();
  }
}

/* Google sign-in click handler */
document.getElementById('btn-google-signin').addEventListener('click', function() {
  if (typeof firebase === 'undefined' || !firebase.auth) {
    showError('Firebase not loaded. Please refresh and try again.');
    return;
  }

  document.getElementById('btn-google-signin').style.display = 'none';
  document.getElementById('auth-loading').style.display = 'block';

  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({ prompt: 'select_account' });

  firebase.auth().signInWithPopup(provider)
    .then(function(result) {
      const email = result.user.email;
      if (!isAdminEmail(email)) {
        // Not authorized â€” sign them out immediately
        firebase.auth().signOut();
        showError('Access denied. ' + email + ' is not an authorized admin.');
      }
      // Auth state listener below will handle showing the app
    })
    .catch(function(err) {
      console.warn('Google sign-in error:', err);
      if (err.code === 'auth/popup-closed-by-user') {
        document.getElementById('auth-loading').style.display = 'none';
        document.getElementById('btn-google-signin').style.display = '';
      } else {
        showError(err.message || 'Sign-in failed. Please try again.');
      }
    });
});

document.getElementById('btn-logout').addEventListener('click', logout);


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   2. FIREBASE INITIALIZATION
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

const FIREBASE_CONFIG = {
  apiKey: "__FIREBASE_API_KEY__",
  authDomain: "__FIREBASE_AUTH_DOMAIN__",
  databaseURL: "__FIREBASE_DATABASE_URL__",
  projectId: "__FIREBASE_PROJECT_ID__",
  storageBucket: "__FIREBASE_STORAGE_BUCKET__",
  messagingSenderId: "__FIREBASE_MESSAGING_SENDER_ID__",
  appId: "__FIREBASE_APP_ID__"
};

let db = null;
let firebaseReady = false;

function initFirebase() {
  try {
    if (typeof firebase === 'undefined') {
      showFirebaseWarning();
      return false;
    }
    // Check if actually configured (placeholder token check)
    if (FIREBASE_CONFIG.apiKey.indexOf('__FIREBASE') === 0) {
      showFirebaseWarning();
      return false;
    }
    if (!firebase.apps.length) {
      firebase.initializeApp(FIREBASE_CONFIG);
    }
    db = firebase.database();
    firebaseReady = true;

    // Set up auth state listener
    firebase.auth().onAuthStateChanged(function(user) {
      if (user && isAdminEmail(user.email)) {
        showApp(user);
      } else if (user) {
        // Signed in but not authorized
        firebase.auth().signOut();
        showError('Access denied. ' + user.email + ' is not an authorized admin.');
      } else {
        // No user signed in â€” show the auth overlay
        document.getElementById('auth-overlay').classList.remove('hidden');
        document.getElementById('app').style.display = 'none';
        document.getElementById('btn-google-signin').style.display = '';
        document.getElementById('auth-loading').style.display = 'none';
      }
    });

    return true;
  } catch (err) {
    console.warn('Firebase init failed:', err);
    showFirebaseWarning();
    return false;
  }
}

function showFirebaseWarning() {
  document.getElementById('firebase-warning').style.display = 'block';
}

function fbRef(path) {
  if (!db) return null;
  return db.ref(path);
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   3. HELPER UTILITIES
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function getToday() {
  const d = new Date();
  return d.getFullYear() + '-' +
    String(d.getMonth() + 1).padStart(2, '0') + '-' +
    String(d.getDate()).padStart(2, '0');
}

function getDateOffset(daysAgo) {
  const d = new Date();
  d.setDate(d.getDate() - daysAgo);
  return d.getFullYear() + '-' +
    String(d.getMonth() + 1).padStart(2, '0') + '-' +
    String(d.getDate()).padStart(2, '0');
}

function formatNumber(n) {
  if (n === null || n === undefined) return 'â€”';
  return Number(n).toLocaleString('en-US');
}

function formatDate(dateStr) {
  if (!dateStr) return 'â€”';
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  } catch { return dateStr; }
}

function formatDateTime(dateStr) {
  if (!dateStr) return 'â€”';
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
           d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  } catch { return dateStr; }
}

function formatTimeAgo(dateStr) {
  if (!dateStr) return 'â€”';
  try {
    const d = new Date(dateStr);
    const now = Date.now();
    const diff = now - d.getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'Just now';
    if (mins < 60) return mins + 'm ago';
    const hours = Math.floor(mins / 60);
    if (hours < 24) return hours + 'h ago';
    const days = Math.floor(hours / 24);
    return days + 'd ago';
  } catch { return dateStr; }
}

function formatDuration(seconds) {
  if (!seconds || seconds < 0) return '0s';
  if (seconds < 60) return Math.round(seconds) + 's';
  const mins = Math.floor(seconds / 60);
  const secs = Math.round(seconds % 60);
  return mins + 'm ' + secs + 's';
}

function truncateId(id) {
  if (!id) return 'â€”';
  return id.substring(0, 8) + 'â€¦';
}

function slugToTitle(slug) {
  if (!slug || slug === 'home') return 'Home (/)';
  return '/' + slug.replace(/-/g, '/') + '/';
}

const BRAND_COLORS = ['#C77D8A', '#7A9D54', '#D4A574', '#FFF8F0', '#3498db', '#9b59b6', '#e74c3c', '#1abc9c'];

function getBrandColor(i) {
  return BRAND_COLORS[i % BRAND_COLORS.length];
}

// Chart instances registry for cleanup
const chartInstances = {};

function createChart(canvasId, type, data, options = {}) {
  // Destroy existing chart if present
  if (chartInstances[canvasId]) {
    chartInstances[canvasId].destroy();
  }
  const ctx = document.getElementById(canvasId);
  if (!ctx) return null;

  const defaults = {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: {
        labels: { color: '#8899aa', font: { family: 'Inter', size: 12 } }
      }
    },
    scales: {}
  };

  // Add default scale colors for chart types with axes
  if (['line', 'bar'].includes(type)) {
    defaults.scales = {
      x: { ticks: { color: '#556677' }, grid: { color: 'rgba(30,58,95,0.4)' } },
      y: { ticks: { color: '#556677' }, grid: { color: 'rgba(30,58,95,0.4)' } }
    };
  }

  const merged = deepMerge(defaults, options);

  chartInstances[canvasId] = new Chart(ctx, { type, data, options: merged });
  return chartInstances[canvasId];
}

function deepMerge(target, source) {
  const result = { ...target };
  for (const key of Object.keys(source)) {
    if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
      result[key] = deepMerge(result[key] || {}, source[key]);
    } else {
      result[key] = source[key];
    }
  }
  return result;
}

// Products data cache
let productsData = null;

async function fetchProducts() {
  if (productsData) return productsData;
  try {
    const resp = await fetch('/_data/products.json');
    if (!resp.ok) throw new Error('Failed to fetch products');
    productsData = await resp.json();
    return productsData;
  } catch (err) {
    console.warn('Failed to load products.json:', err);
    return null;
  }
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   4. DATA FETCHING FUNCTIONS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// 4a. Today's visitors â€” count distinct sessions from /pageViews/{today}/
async function fetchTodaysVisitors() {
  if (!firebaseReady) return { total: 0, sessions: new Set() };
  const today = getToday();
  const snap = await fbRef('/pageViews/' + today).once('value');
  const data = snap.val();
  if (!data) return { total: 0, sessions: new Set() };
  const sessions = new Set();
  let total = 0;
  Object.values(data).forEach(pageData => {
    if (typeof pageData === 'object') {
      Object.values(pageData).forEach(entry => {
        total++;
        if (entry.sessionId) sessions.add(entry.sessionId);
      });
    }
  });
  return { total, sessions };
}

// 4b. Live visitors from /presence/
function subscribeLiveVisitors(callback) {
  if (!firebaseReady) { callback({}); return; }
  fbRef('/presence/').on('value', snap => {
    callback(snap.val() || {});
  });
}

// 4c. Traffic over last 30 days
async function fetchTrafficHistory(days = 30) {
  if (!firebaseReady) return {};
  const results = {};
  const promises = [];
  for (let i = days - 1; i >= 0; i--) {
    const date = getDateOffset(i);
    promises.push(
      fbRef('/pageViews/' + date).once('value').then(snap => {
        const data = snap.val();
        let count = 0;
        if (data) {
          Object.values(data).forEach(pageData => {
            if (typeof pageData === 'object') count += Object.keys(pageData).length;
          });
        }
        results[date] = count;
      })
    );
  }
  await Promise.all(promises);
  return results;
}

// 4d. Top pages today
async function fetchTopPagesToday() {
  if (!firebaseReady) return [];
  const today = getToday();
  const snap = await fbRef('/pageViews/' + today).once('value');
  const data = snap.val();
  if (!data) return [];
  const pages = {};
  Object.entries(data).forEach(([slug, entries]) => {
    if (typeof entries === 'object') {
      pages[slug] = Object.keys(entries).length;
    }
  });
  return Object.entries(pages).sort((a, b) => b[1] - a[1]).slice(0, 5);
}

// 4e. Top referrers today
async function fetchTopReferrersByDay() {
  if (!firebaseReady) return [];
  const today = getToday();
  const snap = await fbRef('/pageViews/' + today).once('value');
  const data = snap.val();
  if (!data) return [];
  const referrers = {};
  Object.values(data).forEach(pageData => {
    if (typeof pageData === 'object') {
      Object.values(pageData).forEach(entry => {
        const ref = entry.referrer || 'Direct';
        let host = 'Direct';
        if (ref !== 'Direct' && ref) {
          try { host = new URL(ref).hostname; } catch { host = ref; }
        }
        referrers[host] = (referrers[host] || 0) + 1;
      });
    }
  });
  return Object.entries(referrers).sort((a, b) => b[1] - a[1]).slice(0, 5);
}

// 4f. Traffic sources today
async function fetchTrafficSources() {
  if (!firebaseReady) return {};
  const today = getToday();
  const snap = await fbRef('/pageViews/' + today).once('value');
  const data = snap.val();
  if (!data) return {};
  const sources = {};
  Object.values(data).forEach(pageData => {
    if (typeof pageData === 'object') {
      Object.values(pageData).forEach(entry => {
        const src = entry.source || 'direct';
        sources[src] = (sources[src] || 0) + 1;
      });
    }
  });
  return sources;
}

// 4g. Scroll depth today
async function fetchScrollDepth() {
  if (!firebaseReady) return {};
  const today = getToday();
  const snap = await fbRef('/scrollDepth/' + today).once('value');
  return snap.val() || {};
}

// 4h. Clicks for a specific page
async function fetchClicks(pageSlug) {
  if (!firebaseReady) return [];
  const today = getToday();
  const snap = await fbRef('/clicks/' + today + '/' + pageSlug).once('value');
  const data = snap.val();
  if (!data) return [];
  return Object.values(data);
}

// 4i. Rage clicks for a specific page
async function fetchRageClicks(pageSlug) {
  if (!firebaseReady) return [];
  const today = getToday();
  const snap = await fbRef('/rageClicks/' + today + '/' + pageSlug).once('value');
  const data = snap.val();
  if (!data) return [];
  return Object.values(data);
}

// 4j. Funnel data today
async function fetchFunnelData() {
  if (!firebaseReady) return {};
  const today = getToday();
  const snap = await fbRef('/funnel/' + today).once('value');
  return snap.val() || {};
}

// 4k. Newsletter data
async function fetchNewsletterData(days = 14) {
  if (!firebaseReady) return {};
  const results = {};
  const promises = [];
  for (let i = days - 1; i >= 0; i--) {
    const date = getDateOffset(i);
    promises.push(
      fbRef('/newsletter/' + date).once('value').then(snap => {
        results[date] = snap.val() || {};
      })
    );
  }
  await Promise.all(promises);
  return results;
}

// 4l. Newsletter dismiss details today
async function fetchDismissDetails() {
  if (!firebaseReady) return [];
  const today = getToday();
  const snap = await fbRef('/newsletter/' + today + '/dismiss_details').once('value');
  const data = snap.val();
  if (!data) return [];
  return Object.values(data);
}

// 4m. Visitor intent data
async function fetchIntentData() {
  if (!firebaseReady) return {};
  const snap = await fbRef('/visitors/').once('value');
  return snap.val() || {};
}

// 4n. Cart data today
async function fetchCartData() {
  if (!firebaseReady) return [];
  const today = getToday();
  const snap = await fbRef('/cart/' + today).once('value');
  const data = snap.val();
  if (!data) return [];
  return Object.values(data);
}

// 4o. Performance data today
async function fetchPerformanceData() {
  if (!firebaseReady) return {};
  const today = getToday();
  const snap = await fbRef('/performance/' + today).once('value');
  return snap.val() || {};
}

// 4p. Error log today
async function fetchErrors() {
  if (!firebaseReady) return [];
  const today = getToday();
  const snap = await fbRef('/errors/' + today).once('value');
  const data = snap.val();
  if (!data) return [];
  return Object.values(data);
}

// 4q. GitHub deployments
async function fetchDeployments(count = 10) {
  try {
    const resp = await fetch(
      'https://api.github.com/repos/magnetmomentsco/magnetmomentsco.github.io/actions/runs?per_page=' + count
    );
    if (!resp.ok) throw new Error('GitHub API error');
    const data = await resp.json();
    return data.workflow_runs || [];
  } catch (err) {
    console.warn('Failed to fetch deployments:', err);
    return [];
  }
}

// 4r. Last successful deploy
async function fetchLastDeploy() {
  try {
    const resp = await fetch(
      'https://api.github.com/repos/magnetmomentsco/magnetmomentsco.github.io/actions/runs?per_page=1&status=success'
    );
    if (!resp.ok) throw new Error('GitHub API error');
    const data = await resp.json();
    return data.workflow_runs?.[0] || null;
  } catch (err) {
    console.warn('Failed to fetch last deploy:', err);
    return null;
  }
}

// 4s. Traffic history for digest (7 days)
async function fetchTrafficForDigest() {
  return fetchTrafficHistory(7);
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   5. RENDERING FUNCTIONS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// â”€â”€â”€ 5a. Top Bar â”€â”€â”€
function renderTopBar() {
  const d = new Date();
  const formatted = d.toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });
  document.getElementById('topbar-date').textContent = formatted;
}

// â”€â”€â”€ 5b. Quick Stats â”€â”€â”€
async function renderQuickStats() {
  // Today's visitors
  try {
    const { total, sessions } = await fetchTodaysVisitors();
    document.getElementById('stat-visitors').textContent = formatNumber(sessions.size);
    document.getElementById('stat-visitors-sub').textContent = formatNumber(total) + ' total pageviews';
  } catch {
    document.getElementById('stat-visitors').textContent = 'â€”';
    document.getElementById('stat-visitors-sub').textContent = 'Unable to load';
  }

  // Products
  try {
    const data = await fetchProducts();
    if (data) {
      const total = data.productCount || data.products?.length || 0;
      const active = data.products?.filter(p => p.availableForSale).length || 0;
      const oos = total - active;
      document.getElementById('stat-products').textContent = total;
      document.getElementById('stat-products-sub').textContent = active + ' active Â· ' + oos + ' out of stock';
    }
  } catch {
    document.getElementById('stat-products').textContent = 'â€”';
  }

  // Last sync
  try {
    const data = await fetchProducts();
    if (data?.lastUpdated) {
      document.getElementById('stat-sync').textContent = formatTimeAgo(data.lastUpdated);
      document.getElementById('stat-sync-sub').textContent = formatDateTime(data.lastUpdated);
    }
  } catch {}

  // Last deploy
  try {
    const deploy = await fetchLastDeploy();
    if (deploy) {
      document.getElementById('stat-deploy').textContent = formatTimeAgo(deploy.created_at);
      document.getElementById('stat-deploy-sub').textContent = formatDateTime(deploy.created_at);
    } else {
      document.getElementById('stat-deploy').textContent = 'â€”';
      document.getElementById('stat-deploy-sub').textContent = 'Unable to fetch';
    }
  } catch {
    document.getElementById('stat-deploy').textContent = 'â€”';
    document.getElementById('stat-deploy-sub').textContent = 'GitHub API unavailable';
  }
}

// â”€â”€â”€ 5c. Live Visitors â”€â”€â”€
function renderLiveVisitors(presenceData) {
  const container = document.getElementById('live-visitors-content');
  const entries = Object.entries(presenceData);

  // Update topbar count
  document.getElementById('live-count').textContent = entries.length + ' visitor' + (entries.length !== 1 ? 's' : '') + ' online';

  if (entries.length === 0) {
    container.innerHTML = '<p class="text-center text-muted" style="padding:20px;">No visitors currently online</p>';
    return;
  }

  let html = '<table class="data-table"><thead><tr>';
  html += '<th>Visitor ID</th><th>Current Page</th><th>Device</th><th>Time on Site</th>';
  html += '</tr></thead><tbody>';

  entries.forEach(([vid, info]) => {
    const timeOnSite = info.timestamp ? formatDuration((Date.now() - info.timestamp) / 1000) : 'â€”';
    html += '<tr>';
    html += '<td><code style="color:var(--gold);font-size:0.8rem;">' + truncateId(vid) + '</code></td>';
    html += '<td>' + (info.page || 'â€”') + '</td>';
    html += '<td>' + (info.device || 'â€”') + '</td>';
    html += '<td>' + timeOnSite + '</td>';
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// â”€â”€â”€ 5d. Traffic Overview Chart â”€â”€â”€
async function renderTrafficChart() {
  const history = await fetchTrafficHistory(30);
  const labels = Object.keys(history).map(d => {
    const parts = d.split('-');
    return parts[1] + '/' + parts[2];
  });
  const values = Object.values(history);

  createChart('chart-traffic', 'line', {
    labels,
    datasets: [{
      label: 'Pageviews',
      data: values,
      borderColor: '#C77D8A',
      backgroundColor: 'rgba(199, 125, 138, 0.1)',
      fill: true,
      tension: 0.4,
      pointRadius: 3,
      pointBackgroundColor: '#C77D8A',
      pointBorderColor: '#C77D8A',
      borderWidth: 2
    }]
  }, {
    plugins: { legend: { display: false } },
    scales: {
      y: { beginAtZero: true }
    }
  });

  // Top pages
  const topPages = await fetchTopPagesToday();
  const pagesEl = document.getElementById('top-pages');
  if (topPages.length === 0) {
    pagesEl.innerHTML = '<p class="text-muted">No data yet today</p>';
  } else {
    let html = '<table class="data-table"><tbody>';
    topPages.forEach(([slug, count], i) => {
      html += '<tr><td style="color:var(--gold);">' + (i + 1) + '.</td><td>' + slugToTitle(slug) + '</td><td style="text-align:right;font-weight:600;">' + formatNumber(count) + '</td></tr>';
    });
    html += '</tbody></table>';
    pagesEl.innerHTML = html;
  }

  // Top referrers
  const topRefs = await fetchTopReferrersByDay();
  const refsEl = document.getElementById('top-referrers');
  if (topRefs.length === 0) {
    refsEl.innerHTML = '<p class="text-muted">No referrer data yet today</p>';
  } else {
    let html = '<table class="data-table"><tbody>';
    topRefs.forEach(([host, count], i) => {
      html += '<tr><td style="color:var(--gold);">' + (i + 1) + '.</td><td>' + host + '</td><td style="text-align:right;font-weight:600;">' + formatNumber(count) + '</td></tr>';
    });
    html += '</tbody></table>';
    refsEl.innerHTML = html;
  }
}

// â”€â”€â”€ 5e. Traffic Sources â”€â”€â”€
async function renderTrafficSources() {
  const sources = await fetchTrafficSources();
  const labels = Object.keys(sources).map(s => s.charAt(0).toUpperCase() + s.slice(1));
  const values = Object.values(sources);
  const colors = ['#C77D8A', '#7A9D54', '#D4A574', '#3498db', '#9b59b6'];

  if (labels.length === 0) {
    document.getElementById('sources-breakdown').innerHTML = '<p class="text-muted text-center">No data yet today</p>';
    return;
  }

  createChart('chart-sources', 'doughnut', {
    labels,
    datasets: [{
      data: values,
      backgroundColor: colors.slice(0, labels.length),
      borderColor: '#16213e',
      borderWidth: 2
    }]
  }, {
    plugins: { legend: { position: 'bottom' } },
    cutout: '60%'
  });

  // Breakdown details
  const total = values.reduce((a, b) => a + b, 0);
  let html = '<table class="data-table"><thead><tr><th>Source</th><th>Visits</th><th>%</th></tr></thead><tbody>';
  labels.forEach((label, i) => {
    const pct = total > 0 ? ((values[i] / total) * 100).toFixed(1) : 0;
    html += '<tr><td><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:' + colors[i] + ';margin-right:8px;"></span>' + label + '</td>';
    html += '<td>' + formatNumber(values[i]) + '</td>';
    html += '<td>' + pct + '%</td></tr>';
  });
  html += '</tbody></table>';
  document.getElementById('sources-breakdown').innerHTML = html;
}

// â”€â”€â”€ 5f. Scroll Depth â”€â”€â”€
async function renderScrollDepth() {
  const data = await fetchScrollDepth();
  if (Object.keys(data).length === 0) {
    const ctx = document.getElementById('chart-scroll');
    if (ctx) ctx.parentElement.innerHTML = '<p class="text-muted text-center" style="padding:20px;">No scroll data yet today</p>';
    return;
  }

  const pages = Object.keys(data).slice(0, 8);
  const thresholds = ['25', '50', '75', '100'];
  const colors = ['#7A9D54', '#D4A574', '#C77D8A', '#3498db'];

  const datasets = thresholds.map((t, i) => ({
    label: t + '%',
    data: pages.map(p => data[p]?.[t] || 0),
    backgroundColor: colors[i],
    borderColor: colors[i],
    borderWidth: 1
  }));

  createChart('chart-scroll', 'bar', {
    labels: pages.map(slugToTitle),
    datasets
  }, {
    indexAxis: 'y',
    plugins: { legend: { position: 'top' } },
    scales: {
      x: { beginAtZero: true, title: { display: true, text: 'Visitors', color: '#556677' } }
    }
  });
}

// â”€â”€â”€ 5g. Click Heatmap â”€â”€â”€
async function renderClickHeatmapPageList() {
  if (!firebaseReady) return;
  const today = getToday();
  const snap = await fbRef('/clicks/' + today).once('value');
  const data = snap.val();
  if (!data) return;

  const select = document.getElementById('heatmap-page-select');
  Object.keys(data).forEach(slug => {
    const opt = document.createElement('option');
    opt.value = slug;
    opt.textContent = slugToTitle(slug);
    select.appendChild(opt);
  });
}

async function loadClickHeatmap() {
  const slug = document.getElementById('heatmap-page-select').value;
  if (!slug) return;

  const [clicks, rageClicks] = await Promise.all([
    fetchClicks(slug),
    fetchRageClicks(slug)
  ]);

  // Scatter plot of clicks
  if (clicks.length > 0) {
    const pointData = clicks.map(c => ({ x: c.x, y: c.y }));
    createChart('chart-clicks', 'scatter', {
      datasets: [{
        label: 'Clicks',
        data: pointData,
        backgroundColor: 'rgba(199, 125, 138, 0.5)',
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    }, {
      scales: {
        x: { min: 0, max: 100, title: { display: true, text: 'X Position (%)', color: '#556677' } },
        y: { min: 0, max: 100, reverse: true, title: { display: true, text: 'Y Position (%)', color: '#556677' } }
      },
      plugins: { legend: { display: false } }
    });
  }

  // Rage clicks table
  const rageEl = document.getElementById('rage-clicks-content');
  if (rageClicks.length === 0) {
    rageEl.innerHTML = '<p class="text-muted">No rage clicks detected on this page</p>';
  } else {
    let html = '<table class="data-table"><thead><tr><th>Position</th><th>Clicks</th><th>Timestamp</th></tr></thead><tbody>';
    rageClicks.forEach(rc => {
      html += '<tr>';
      html += '<td>(' + Math.round(rc.x) + ', ' + Math.round(rc.y) + ')</td>';
      html += '<td style="font-weight:600;color:var(--red);">' + (rc.count || 'â€”') + '</td>';
      html += '<td>' + formatDateTime(rc.ts) + '</td>';
      html += '</tr>';
    });
    html += '</tbody></table>';
    rageEl.innerHTML = html;
  }
}
// Expose to onclick
window.loadClickHeatmap = loadClickHeatmap;

// â”€â”€â”€ 5h. Product Engagement Funnel â”€â”€â”€
async function renderFunnel() {
  const data = await fetchFunnelData();
  const container = document.getElementById('funnel-bars');
  const tableContainer = document.getElementById('funnel-table');

  const steps = [
    { key: 'product-card-hover', label: 'Product Card Hover', color: '#7A9D54' },
    { key: 'modal-open', label: 'Modal Open', color: '#D4A574' },
    { key: 'image-browse', label: 'Image Browse', color: '#C77D8A' },
    { key: 'add-to-cart', label: 'Add to Cart', color: '#3498db' },
    { key: 'checkout-start', label: 'Checkout', color: '#9b59b6' }
  ];

  // Sum totals per step
  const totals = {};
  steps.forEach(s => {
    const stepData = data[s.key] || {};
    totals[s.key] = Object.values(stepData).reduce((a, b) => a + (typeof b === 'number' ? b : 0), 0);
  });

  const maxVal = Math.max(...Object.values(totals), 1);

  if (maxVal <= 0 || Object.values(totals).every(v => v === 0)) {
    container.innerHTML = '<p class="text-muted text-center" style="padding:20px;">No funnel data yet today</p>';
    tableContainer.innerHTML = '';
    return;
  }

  let html = '';
  steps.forEach(s => {
    const val = totals[s.key] || 0;
    const pct = (val / maxVal) * 100;
    html += '<div class="funnel-bar">';
    html += '<div class="funnel-label">' + s.label + '</div>';
    html += '<div class="funnel-track"><div class="funnel-fill" style="width:' + pct + '%;background:' + s.color + ';">' + formatNumber(val) + '</div></div>';
    html += '</div>';
  });
  container.innerHTML = html;

  // Per-product breakdown
  const products = new Set();
  steps.forEach(s => {
    const stepData = data[s.key] || {};
    Object.keys(stepData).forEach(p => products.add(p));
  });

  if (products.size === 0) {
    tableContainer.innerHTML = '<p class="text-muted">No per-product data available</p>';
    return;
  }

  let tbl = '<table class="data-table"><thead><tr><th>Product</th>';
  steps.forEach(s => { tbl += '<th>' + s.label + '</th>'; });
  tbl += '</tr></thead><tbody>';

  products.forEach(prod => {
    tbl += '<tr><td class="truncate" title="' + prod + '">' + prod + '</td>';
    steps.forEach(s => {
      const val = data[s.key]?.[prod] || 0;
      tbl += '<td>' + formatNumber(val) + '</td>';
    });
    tbl += '</tr>';
  });
  tbl += '</tbody></table>';
  tableContainer.innerHTML = tbl;
}

// â”€â”€â”€ 5i. Newsletter Popup â”€â”€â”€
async function renderNewsletter() {
  const nlData = await fetchNewsletterData(14);
  const dismissDetails = await fetchDismissDetails();

  const today = getToday();
  const todayData = nlData[today] || {};

  // Stats cards
  const shown = todayData.popup_shown || 0;
  const dismissed = todayData.popup_dismissed || 0;
  const submitted = todayData.popup_submitted || 0;
  const rate = shown > 0 ? ((submitted / shown) * 100).toFixed(1) : '0.0';

  document.getElementById('nl-stats').innerHTML = `
    <div class="nl-card"><div class="nl-val">${formatNumber(shown)}</div><div class="nl-label">Shown</div></div>
    <div class="nl-card"><div class="nl-val">${formatNumber(dismissed)}</div><div class="nl-label">Dismissed</div></div>
    <div class="nl-card"><div class="nl-val">${formatNumber(submitted)}</div><div class="nl-label">Submitted</div></div>
    <div class="nl-card"><div class="nl-val">${rate}%</div><div class="nl-label">Conversion Rate</div></div>
  `;

  // Trend chart (14 days)
  const dates = Object.keys(nlData).sort();
  const shownArr = dates.map(d => nlData[d]?.popup_shown || 0);
  const submittedArr = dates.map(d => nlData[d]?.popup_submitted || 0);
  const labels = dates.map(d => { const p = d.split('-'); return p[1] + '/' + p[2]; });

  createChart('chart-newsletter-trend', 'line', {
    labels,
    datasets: [
      {
        label: 'Shown',
        data: shownArr,
        borderColor: '#D4A574',
        backgroundColor: 'rgba(212, 165, 116, 0.1)',
        fill: true, tension: 0.4, borderWidth: 2
      },
      {
        label: 'Submitted',
        data: submittedArr,
        borderColor: '#7A9D54',
        backgroundColor: 'rgba(122, 157, 84, 0.1)',
        fill: true, tension: 0.4, borderWidth: 2
      }
    ]
  }, { scales: { y: { beginAtZero: true } } });

  // Dismiss methods donut
  const methods = {};
  dismissDetails.forEach(d => {
    const m = d.method || 'unknown';
    methods[m] = (methods[m] || 0) + 1;
  });

  if (Object.keys(methods).length > 0) {
    createChart('chart-newsletter-dismiss', 'doughnut', {
      labels: Object.keys(methods).map(m => m.charAt(0).toUpperCase() + m.slice(1)),
      datasets: [{
        data: Object.values(methods),
        backgroundColor: ['#C77D8A', '#D4A574', '#7A9D54', '#3498db'],
        borderColor: '#16213e',
        borderWidth: 2
      }]
    }, {
      plugins: {
        legend: { position: 'bottom' },
        title: { display: true, text: 'Dismiss Methods', color: '#8899aa', font: { size: 13 } }
      },
      cutout: '55%'
    });
  }
}

// â”€â”€â”€ 5j. Visitor Intent â”€â”€â”€
async function renderIntent() {
  const visitors = await fetchIntentData();
  const levels = { high: 0, medium: 0, low: 0 };

  Object.values(visitors).forEach(v => {
    const level = v?.intent?.level || 'low';
    levels[level] = (levels[level] || 0) + 1;
  });

  const total = Object.values(levels).reduce((a, b) => a + b, 0);

  createChart('chart-intent', 'doughnut', {
    labels: ['High Intent', 'Medium Intent', 'Low Intent'],
    datasets: [{
      data: [levels.high, levels.medium, levels.low],
      backgroundColor: ['#7A9D54', '#D4A574', '#C77D8A'],
      borderColor: '#16213e',
      borderWidth: 2
    }]
  }, {
    plugins: { legend: { position: 'bottom' } },
    cutout: '55%'
  });

  // Details
  const detailsEl = document.getElementById('intent-details');
  if (total === 0) {
    detailsEl.innerHTML = '<p class="text-muted text-center">No visitor intent data available</p>';
    return;
  }
  let html = '<table class="data-table"><thead><tr><th>Intent Level</th><th>Visitors</th><th>%</th></tr></thead><tbody>';
  [['High', levels.high, '#7A9D54'], ['Medium', levels.medium, '#D4A574'], ['Low', levels.low, '#C77D8A']].forEach(([label, count, color]) => {
    const pct = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
    html += '<tr><td><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:' + color + ';margin-right:8px;"></span>' + label + '</td>';
    html += '<td>' + formatNumber(count) + '</td><td>' + pct + '%</td></tr>';
  });
  html += '</tbody></table>';
  detailsEl.innerHTML = html;
}

// â”€â”€â”€ 5k. Cart Analytics â”€â”€â”€
async function renderCartAnalytics() {
  const cartData = await fetchCartData();

  if (cartData.length === 0) {
    const c1 = document.getElementById('chart-cart-products');
    const c2 = document.getElementById('chart-cart-hours');
    if (c1) c1.parentElement.innerHTML = '<p class="text-muted text-center" style="padding:20px;">No cart data yet today</p>';
    if (c2) c2.parentElement.innerHTML = '<p class="text-muted text-center" style="padding:20px;">No cart data yet today</p>';
    return;
  }

  // Top products
  const productCounts = {};
  cartData.forEach(entry => {
    if (entry.items && Array.isArray(entry.items)) {
      entry.items.forEach(item => {
        const name = item.title || item.handle || 'Unknown';
        productCounts[name] = (productCounts[name] || 0) + 1;
      });
    }
  });

  const sortedProducts = Object.entries(productCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);

  if (sortedProducts.length > 0) {
    createChart('chart-cart-products', 'bar', {
      labels: sortedProducts.map(p => p[0].length > 25 ? p[0].substring(0, 25) + 'â€¦' : p[0]),
      datasets: [{
        label: 'Cart Additions',
        data: sortedProducts.map(p => p[1]),
        backgroundColor: '#C77D8A',
        borderRadius: 6
      }]
    }, {
      indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: { x: { beginAtZero: true } }
    });
  }

  // By hour
  const hourCounts = new Array(24).fill(0);
  cartData.forEach(entry => {
    if (entry.timestamp) {
      try {
        const h = new Date(entry.timestamp).getHours();
        hourCounts[h]++;
      } catch {}
    }
  });

  createChart('chart-cart-hours', 'line', {
    labels: hourCounts.map((_, i) => (i < 10 ? '0' : '') + i + ':00'),
    datasets: [{
      label: 'Cart Additions',
      data: hourCounts,
      borderColor: '#D4A574',
      backgroundColor: 'rgba(212, 165, 116, 0.1)',
      fill: true, tension: 0.4, borderWidth: 2, pointRadius: 3
    }]
  }, {
    plugins: { legend: { display: false } },
    scales: { y: { beginAtZero: true } }
  });
}

// â”€â”€â”€ 5l. Performance Metrics â”€â”€â”€
async function renderPerformance() {
  const perfData = await fetchPerformanceData();
  const gaugesEl = document.getElementById('perf-gauges');

  // Aggregate from all page entries
  const metrics = { lcp: [], fid: [], cls: [], ttfb: [] };
  const devices = {};

  Object.values(perfData).forEach(pageData => {
    if (typeof pageData === 'object') {
      Object.values(pageData).forEach(entry => {
        if (entry.lcp !== undefined) metrics.lcp.push(entry.lcp);
        if (entry.fid !== undefined) metrics.fid.push(entry.fid);
        if (entry.cls !== undefined) metrics.cls.push(entry.cls);
        if (entry.ttfb !== undefined) metrics.ttfb.push(entry.ttfb);
        if (entry.device) devices[entry.device] = (devices[entry.device] || 0) + 1;
      });
    }
  });

  const avg = arr => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : null;

  const avgLcp = avg(metrics.lcp);
  const avgFid = avg(metrics.fid);
  const avgCls = avg(metrics.cls);
  const avgTtfb = avg(metrics.ttfb);

  function cwvClass(metric, val) {
    if (val === null) return '';
    if (metric === 'lcp') return val < 2500 ? 'green' : val < 4000 ? 'yellow' : 'red';
    if (metric === 'fid') return val < 100 ? 'green' : val < 300 ? 'yellow' : 'red';
    if (metric === 'cls') return val < 0.1 ? 'green' : val < 0.25 ? 'yellow' : 'red';
    if (metric === 'ttfb') return val < 800 ? 'green' : val < 1800 ? 'yellow' : 'red';
    return '';
  }

  function formatMetric(metric, val) {
    if (val === null) return 'â€”';
    if (metric === 'cls') return val.toFixed(3);
    return Math.round(val).toLocaleString();
  }

  function metricUnit(metric) {
    if (metric === 'cls') return 'score';
    return 'ms';
  }

  const gaugeConfigs = [
    { key: 'lcp', label: 'LCP', val: avgLcp },
    { key: 'fid', label: 'FID', val: avgFid },
    { key: 'cls', label: 'CLS', val: avgCls },
    { key: 'ttfb', label: 'TTFB', val: avgTtfb }
  ];

  if (gaugeConfigs.every(g => g.val === null)) {
    gaugesEl.innerHTML = '<p class="text-muted text-center" style="grid-column:1/-1;padding:20px;">No performance data yet today</p>';
  } else {
    let html = '';
    gaugeConfigs.forEach(g => {
      const cls = cwvClass(g.key, g.val);
      html += '<div class="gauge-card ' + cls + '">';
      html += '<div class="gauge-label">' + g.label + '</div>';
      html += '<div class="gauge-value">' + formatMetric(g.key, g.val) + '</div>';
      html += '<div class="gauge-unit">' + metricUnit(g.key) + '</div>';
      html += '</div>';
    });
    gaugesEl.innerHTML = html;
  }

  // Device breakdown
  if (Object.keys(devices).length > 0) {
    createChart('chart-devices', 'doughnut', {
      labels: Object.keys(devices).map(d => d.charAt(0).toUpperCase() + d.slice(1)),
      datasets: [{
        data: Object.values(devices),
        backgroundColor: ['#C77D8A', '#7A9D54', '#D4A574'],
        borderColor: '#16213e',
        borderWidth: 2
      }]
    }, {
      plugins: { legend: { position: 'bottom' } },
      cutout: '55%'
    });
  }
}

// â”€â”€â”€ 5m. SEO Health â”€â”€â”€
async function renderSEOHealth() {
  const pages = [
    { path: '/', label: 'Home' },
    { path: '/shop/', label: 'Shop' },
    { path: '/about/', label: 'About' },
    { path: '/contact/', label: 'Contact' },
    { path: '/faq/', label: 'FAQ' },
    { path: '/events/', label: 'Events' },
    { path: '/wholesale/', label: 'Wholesale' }
  ];

  const container = document.getElementById('seo-table');
  let results = [];

  const checks = pages.map(async (page) => {
    try {
      const resp = await fetch(page.path);
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const html = await resp.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      const title = !!doc.querySelector('title')?.textContent?.trim();
      const metaDesc = !!doc.querySelector('meta[name="description"]')?.getAttribute('content')?.trim();
      const ogImage = !!doc.querySelector('meta[property="og:image"]')?.getAttribute('content')?.trim();
      const ogTitle = !!doc.querySelector('meta[property="og:title"]')?.getAttribute('content')?.trim();
      const h1 = !!doc.querySelector('h1');
      const images = doc.querySelectorAll('img');
      let imagesWithAlt = 0;
      let totalImages = images.length;
      images.forEach(img => { if (img.getAttribute('alt')?.trim()) imagesWithAlt++; });
      const altScore = totalImages > 0 ? Math.round((imagesWithAlt / totalImages) * 100) : 100;

      let score = 0;
      if (title) score += 20;
      if (metaDesc) score += 20;
      if (ogImage) score += 15;
      if (ogTitle) score += 15;
      if (h1) score += 15;
      score += Math.round(altScore * 0.15);

      results.push({
        label: page.label,
        path: page.path,
        title, metaDesc, ogImage, ogTitle, h1, altScore, score
      });
    } catch (err) {
      results.push({
        label: page.label, path: page.path,
        title: false, metaDesc: false, ogImage: false, ogTitle: false,
        h1: false, altScore: 0, score: 0, error: err.message
      });
    }
  });

  await Promise.all(checks);
  results.sort((a, b) => pages.findIndex(p => p.label === a.label) - pages.findIndex(p => p.label === b.label));

  const pass = '<span class="seo-pass">âœ…</span>';
  const fail = '<span class="seo-fail">âŒ</span>';

  let html = '<table class="data-table"><thead><tr>';
  html += '<th>Page</th><th>Title</th><th>Meta Desc</th><th>OG Image</th><th>OG Title</th><th>H1</th><th>Alt Attrs</th><th>Score</th>';
  html += '</tr></thead><tbody>';

  results.forEach(r => {
    const scoreColor = r.score >= 80 ? 'var(--green)' : r.score >= 50 ? 'var(--yellow)' : 'var(--red)';
    html += '<tr>';
    html += '<td><a href="' + r.path + '" target="_blank">' + r.label + '</a></td>';
    html += '<td>' + (r.title ? pass : fail) + '</td>';
    html += '<td>' + (r.metaDesc ? pass : fail) + '</td>';
    html += '<td>' + (r.ogImage ? pass : fail) + '</td>';
    html += '<td>' + (r.ogTitle ? pass : fail) + '</td>';
    html += '<td>' + (r.h1 ? pass : fail) + '</td>';
    html += '<td>' + r.altScore + '%</td>';
    html += '<td class="seo-score" style="color:' + scoreColor + ';">' + r.score + '</td>';
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// â”€â”€â”€ 5n. Error Log â”€â”€â”€
async function renderErrors() {
  const errors = await fetchErrors();
  const container = document.getElementById('errors-content');
  const badge = document.getElementById('error-badge');

  if (errors.length > 0) {
    badge.style.display = '';
    badge.textContent = errors.length;
  }

  if (errors.length === 0) {
    container.innerHTML = '<p class="text-muted text-center" style="padding:20px;">ğŸ‰ No errors today!</p>';
    return;
  }

  // Separate 404s and other errors
  const regularErrors = errors.filter(e => e.kind !== 'image');
  const imageErrors = errors.filter(e => e.kind === 'image');

  let html = '<table class="data-table"><thead><tr>';
  html += '<th>Time</th><th>Type</th><th>Message</th><th>Source</th><th>Page</th>';
  html += '</tr></thead><tbody>';

  regularErrors.slice(0, 50).forEach(err => {
    html += '<tr>';
    html += '<td style="white-space:nowrap;">' + formatDateTime(err.timestamp) + '</td>';
    html += '<td><span class="status-badge failure">' + (err.kind || 'error') + '</span></td>';
    html += '<td class="truncate" title="' + (err.message || '').replace(/"/g, '&quot;') + '">' + (err.message || 'â€”') + '</td>';
    html += '<td class="truncate">' + (err.source ? err.source.split('/').pop() + ':' + (err.line || '') : 'â€”') + '</td>';
    html += '<td>' + (err.page || 'â€”') + '</td>';
    html += '</tr>';
  });
  html += '</tbody></table>';

  if (imageErrors.length > 0) {
    html += '<h4 style="font-size:0.95rem;color:var(--text-muted);margin:20px 0 10px;">ğŸ–¼ï¸ Image Load Errors (' + imageErrors.length + ')</h4>';
    html += '<table class="data-table"><thead><tr><th>Time</th><th>Source</th><th>Page</th></tr></thead><tbody>';
    imageErrors.slice(0, 20).forEach(err => {
      html += '<tr>';
      html += '<td>' + formatDateTime(err.timestamp) + '</td>';
      html += '<td class="truncate">' + (err.src || 'â€”') + '</td>';
      html += '<td>' + (err.page || 'â€”') + '</td>';
      html += '</tr>';
    });
    html += '</tbody></table>';
  }

  container.innerHTML = html;
}

// â”€â”€â”€ 5o. Social Proof Config â”€â”€â”€
function loadSocialProofConfig() {
  try {
    const config = JSON.parse(localStorage.getItem('mm_social_proof') || '{}');
    document.getElementById('sp-enabled').checked = config.enabled !== false;
    document.getElementById('sp-threshold').value = config.threshold || 5;
    document.getElementById('sp-style').value = config.style || 'subtle';
  } catch {}
}

function saveSocialProofConfig() {
  const config = {
    enabled: document.getElementById('sp-enabled').checked,
    threshold: parseInt(document.getElementById('sp-threshold').value) || 5,
    style: document.getElementById('sp-style').value
  };
  localStorage.setItem('mm_social_proof', JSON.stringify(config));
  renderSocialProofPreview();
}
window.saveSocialProofConfig = saveSocialProofConfig;

async function renderSocialProofPreview() {
  const container = document.getElementById('sp-preview');
  const data = await fetchProducts();
  if (!data?.products) {
    container.innerHTML = '<p class="text-muted">No product data available</p>';
    return;
  }

  // Fetch real product view counts from Firebase
  const productViewCache = {};
  if (firebaseReady) {
    try {
      const today = getToday();
      const snap = await fbRef('/productViewCounts/' + today).once('value');
      const counts = snap.val() || {};
      Object.entries(counts).forEach(([slug, count]) => {
        productViewCache[slug] = typeof count === 'number' ? count : 0;
      });
    } catch (e) { console.warn('Failed to fetch product view counts:', e); }
  }

  const threshold = parseInt(document.getElementById('sp-threshold').value) || 5;
  const enabled = document.getElementById('sp-enabled').checked;
  const style = document.getElementById('sp-style').value;

  let html = '<table class="data-table"><thead><tr><th>Product</th><th>Badge Preview</th></tr></thead><tbody>';
  data.products.forEach(p => {
    // Real data from Firebase productViewCounts
    const viewCount = productViewCache[('shop-' + p.handle)] || 0;
    const wouldShow = enabled && viewCount >= threshold;
    let badgeHtml = '<span class="text-muted" style="font-size:0.8rem;">Hidden (below threshold)</span>';
    if (wouldShow) {
      const styles = {
        subtle: 'background:rgba(122,157,84,0.15);color:var(--green);padding:4px 10px;border-radius:12px;font-size:0.78rem;',
        bold: 'background:var(--green);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.78rem;font-weight:600;',
        animated: 'background:rgba(212,165,116,0.2);color:var(--gold);padding:4px 10px;border-radius:12px;font-size:0.78rem;animation:pulse 2s infinite;'
      };
      badgeHtml = '<span style="' + (styles[style] || styles.subtle) + '">ğŸ‘ ' + viewCount + ' viewed today</span>';
    }
    html += '<tr><td>' + p.title + '</td><td>' + badgeHtml + '</td></tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

// â”€â”€â”€ 5p. Weekly Digest Generator â”€â”€â”€
async function generateDigest() {
  const btn = document.getElementById('btn-digest');
  const output = document.getElementById('digest-output');
  btn.disabled = true;
  btn.textContent = 'Generatingâ€¦';
  output.value = 'Collecting dataâ€¦\n';

  try {
    const traffic = await fetchTrafficForDigest();
    const products = await fetchProducts();
    const topPages = await fetchTopPagesToday();
    const errors = await fetchErrors();

    const dates = Object.keys(traffic).sort();
    const totalPV = Object.values(traffic).reduce((a, b) => a + b, 0);
    const avgPV = dates.length > 0 ? Math.round(totalPV / dates.length) : 0;

    // Trend: compare last 3 days to previous 4
    const recent = dates.slice(-3).reduce((a, d) => a + (traffic[d] || 0), 0);
    const earlier = dates.slice(0, 4).reduce((a, d) => a + (traffic[d] || 0), 0);
    const trend = recent > earlier ? 'ğŸ“ˆ Up' : recent < earlier ? 'ğŸ“‰ Down' : 'â¡ï¸ Flat';

    let report = '';
    report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
    report += '  MAGNET MOMENTS CO. â€” WEEKLY DIGEST\n';
    report += '  ' + dates[0] + ' to ' + dates[dates.length - 1] + '\n';
    report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';

    report += 'ğŸ“Š TRAFFIC SUMMARY\n';
    report += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    report += '  Total Pageviews:     ' + formatNumber(totalPV) + '\n';
    report += '  Daily Average:       ' + formatNumber(avgPV) + '\n';
    report += '  Trend:               ' + trend + '\n\n';

    report += '  Daily Breakdown:\n';
    dates.forEach(d => {
      const bar = 'â–ˆ'.repeat(Math.min(Math.round((traffic[d] || 0) / Math.max(avgPV, 1) * 10), 30));
      report += '    ' + d + '  ' + String(traffic[d] || 0).padStart(6) + '  ' + bar + '\n';
    });
    report += '\n';

    report += 'ğŸ“„ TOP PAGES TODAY\n';
    report += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    if (topPages.length > 0) {
      topPages.forEach(([slug, count], i) => {
        report += '  ' + (i + 1) + '. ' + slugToTitle(slug).padEnd(30) + formatNumber(count) + '\n';
      });
    } else {
      report += '  No page data available\n';
    }
    report += '\n';

    report += 'ğŸ“¦ PRODUCT CATALOG\n';
    report += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    if (products) {
      report += '  Total Products:      ' + (products.productCount || 0) + '\n';
      report += '  Active:              ' + (products.products?.filter(p => p.availableForSale).length || 0) + '\n';
      report += '  Last Sync:           ' + formatDateTime(products.lastUpdated) + '\n';
      report += '\n  Products:\n';
      products.products?.forEach(p => {
        const price = p.priceRange?.minVariantPrice?.amount || 'â€”';
        const stock = p.availableForSale ? 'âœ… In Stock' : 'âŒ Out of Stock';
        report += '    â€¢ ' + p.title + ' â€” $' + price + ' â€” ' + stock + '\n';
      });
    }
    report += '\n';

    report += 'ğŸ› ERRORS\n';
    report += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    report += '  Errors today:        ' + errors.length + '\n';
    if (errors.length > 0) {
      const types = {};
      errors.forEach(e => { types[e.kind || 'unknown'] = (types[e.kind || 'unknown'] || 0) + 1; });
      Object.entries(types).forEach(([type, count]) => {
        report += '    ' + type + ': ' + count + '\n';
      });
    } else {
      report += '  ğŸ‰ No errors detected!\n';
    }
    report += '\n';

    report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
    report += '  Generated: ' + new Date().toISOString() + '\n';
    report += '  Command Center â€” Magnet Moments Co.\n';
    report += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';

    output.value = report;
  } catch (err) {
    output.value = 'Error generating report: ' + err.message;
  }

  btn.disabled = false;
  btn.textContent = 'Generate Report';
}
window.generateDigest = generateDigest;

function copyDigest() {
  const output = document.getElementById('digest-output');
  output.select();
  document.execCommand('copy');
  const btn = event.target;
  const orig = btn.textContent;
  btn.textContent = 'Copied!';
  setTimeout(() => { btn.textContent = orig; }, 2000);
}
window.copyDigest = copyDigest;

// â”€â”€â”€ 5q. Quick Links â”€â”€â”€
function renderQuickLinks() {
  const links = [
    { icon: 'ğŸ›ï¸', title: 'Shopify Admin', url: 'https://dbx3hf-qe.myshopify.com/admin' },
    { icon: 'ğŸ“Š', title: 'Google Analytics', url: 'https://analytics.google.com' },
    { icon: 'ğŸ”', title: 'Google Search Console', url: 'https://search.google.com/search-console' },
    { icon: 'ğŸ“˜', title: 'Facebook Debugger', url: 'https://developers.facebook.com/tools/debug/' },
    { icon: 'ğŸ™', title: 'GitHub Repo', url: 'https://github.com/magnetmomentsco/magnetmomentsco.github.io' },
    { icon: 'âš¡', title: 'GitHub Actions', url: 'https://github.com/magnetmomentsco/magnetmomentsco.github.io/actions' },
    { icon: 'ğŸš€', title: 'PageSpeed Insights', url: 'https://pagespeed.web.dev/analysis?url=https://magnetmomentsco.us' },
    { icon: 'âœ¨', title: 'Rich Results Test', url: 'https://search.google.com/test/rich-results?url=https://magnetmomentsco.us' }
  ];

  let html = '';
  links.forEach(l => {
    const shortUrl = l.url.replace(/^https?:\/\//, '').split('/')[0];
    html += '<a href="' + l.url + '" target="_blank" rel="noopener" class="link-card">';
    html += '<div class="link-icon">' + l.icon + '</div>';
    html += '<div class="link-info"><div class="link-title">' + l.title + '</div>';
    html += '<div class="link-url">' + shortUrl + '</div></div>';
    html += '<div class="link-arrow">â†’</div></a>';
  });

  document.getElementById('quick-links-grid').innerHTML = html;
}

// â”€â”€â”€ 5r. Deployment History â”€â”€â”€
async function renderDeployments() {
  const container = document.getElementById('deploys-content');
  const runs = await fetchDeployments(10);

  if (runs.length === 0) {
    container.innerHTML = '<p class="text-muted text-center" style="padding:20px;">Unable to fetch deployment history</p>';
    return;
  }

  let html = '<table class="data-table"><thead><tr>';
  html += '<th>Commit</th><th>Author</th><th>Status</th><th>Date</th><th>Link</th>';
  html += '</tr></thead><tbody>';

  runs.forEach(run => {
    const status = run.conclusion === 'success'
      ? '<span class="status-badge success">âœ… Success</span>'
      : run.conclusion === 'failure'
      ? '<span class="status-badge failure">âŒ Failed</span>'
      : '<span class="status-badge" style="background:rgba(241,196,15,0.15);color:var(--yellow);">â³ ' + (run.status || 'In Progress') + '</span>';

    const message = (run.head_commit?.message || run.display_title || 'â€”').split('\n')[0];

    html += '<tr>';
    html += '<td class="truncate" title="' + message.replace(/"/g, '&quot;') + '">' + message + '</td>';
    html += '<td>' + (run.head_commit?.author?.name || run.actor?.login || 'â€”') + '</td>';
    html += '<td>' + status + '</td>';
    html += '<td style="white-space:nowrap;">' + formatDateTime(run.created_at) + '</td>';
    html += '<td><a href="' + run.html_url + '" target="_blank">View â†—</a></td>';
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// â”€â”€â”€ 5s. Product Inventory â”€â”€â”€
async function renderInventory() {
  const container = document.getElementById('inventory-content');
  const data = await fetchProducts();

  if (!data?.products) {
    container.innerHTML = '<p class="text-muted text-center" style="padding:20px;">Unable to load product data</p>';
    return;
  }

  const filter = document.getElementById('inv-filter').value;
  const search = (document.getElementById('inv-search').value || '').toLowerCase();

  let products = data.products;

  // Apply filters
  if (filter === 'in-stock') products = products.filter(p => p.availableForSale);
  if (filter === 'out-of-stock') products = products.filter(p => !p.availableForSale);
  if (search) products = products.filter(p => p.title.toLowerCase().includes(search) || (p.handle || '').toLowerCase().includes(search));

  if (products.length === 0) {
    container.innerHTML = '<p class="text-muted text-center" style="padding:20px;">No products match the current filter</p>';
    return;
  }

  let html = '<table class="data-table"><thead><tr>';
  html += '<th></th><th>Title</th><th>Price</th><th>Variants</th><th>Stock</th><th>Actions</th>';
  html += '</tr></thead><tbody>';

  products.forEach(p => {
    const imgUrl = p.featuredImage?.url || '';
    const minPrice = p.priceRange?.minVariantPrice?.amount || '0';
    const maxPrice = p.priceRange?.maxVariantPrice?.amount || '0';
    const price = minPrice === maxPrice ? '$' + parseFloat(minPrice).toFixed(2) : '$' + parseFloat(minPrice).toFixed(2) + 'â€“$' + parseFloat(maxPrice).toFixed(2);
    const variants = p.variants?.nodes?.length || 0;
    const totalInv = p.totalInventory || 0;
    const stockBadge = p.availableForSale
      ? '<span class="status-badge in-stock">In Stock (' + totalInv + ')</span>'
      : '<span class="status-badge out-of-stock">Out of Stock</span>';

    const shopifyId = p.id?.replace('gid://shopify/Product/', '') || '';
    const shopifyUrl = 'https://' + (data.shopifyDomain || 'dbx3hf-qe.myshopify.com') + '/admin/products/' + shopifyId;
    const siteUrl = '/shop/' + p.handle + '/';

    html += '<tr>';
    html += '<td>' + (imgUrl ? '<img src="' + imgUrl + '&width=96" class="prod-thumb" alt="" loading="lazy">' : '') + '</td>';
    html += '<td><strong>' + p.title + '</strong><br><span style="font-size:0.78rem;color:var(--text-dim);">' + p.handle + '</span></td>';
    html += '<td style="white-space:nowrap;">' + price + '</td>';
    html += '<td>' + variants + '</td>';
    html += '<td>' + stockBadge + '</td>';
    html += '<td style="white-space:nowrap;">';
    html += '<a href="' + shopifyUrl + '" target="_blank" class="btn btn-sm btn-secondary" style="margin-right:4px;">Shopify â†—</a>';
    html += '<a href="' + siteUrl + '" target="_blank" class="btn btn-sm btn-secondary">View â†—</a>';
    html += '</td>';
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}
window.renderInventory = renderInventory;


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   5t. SESSION RECORDINGS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// Data fetch
async function fetchSessions(dateStr) {
  if (!firebaseReady) return {};
  const snap = await fbRef('/sessions/' + dateStr).once('value');
  return snap.val() || {};
}

async function renderSessions() {
  const container = document.getElementById('sessions-content');
  const statsEl = document.getElementById('sessions-stats');
  const dateSel = document.getElementById('session-date-select').value;
  const sortBy = document.getElementById('session-sort').value;
  const dateStr = dateSel === 'yesterday' ? getDateOffset(1) : getToday();

  const data = await fetchSessions(dateStr);
  const sessions = Object.entries(data).map(([id, s]) => ({ id, ...s }));

  // Stats
  const totalSessions = sessions.length;
  const avgDuration = totalSessions > 0 ? sessions.reduce((a, s) => a + (s.duration || 0), 0) / totalSessions : 0;
  const avgPages = totalSessions > 0 ? sessions.reduce((a, s) => a + (s.pages || 0), 0) / totalSessions : 0;
  const bounced = sessions.filter(s => (s.pages || 0) <= 1).length;
  const bounceRate = totalSessions > 0 ? ((bounced / totalSessions) * 100).toFixed(1) : '0.0';

  statsEl.innerHTML = `
    <div class="nl-card"><div class="nl-val">${formatNumber(totalSessions)}</div><div class="nl-label">Sessions</div></div>
    <div class="nl-card"><div class="nl-val">${formatDuration(avgDuration)}</div><div class="nl-label">Avg Duration</div></div>
    <div class="nl-card"><div class="nl-val">${avgPages.toFixed(1)}</div><div class="nl-label">Avg Pages</div></div>
    <div class="nl-card"><div class="nl-val">${bounceRate}%</div><div class="nl-label">Bounce Rate</div></div>
  `;

  if (sessions.length === 0) {
    container.innerHTML = '<p class="text-muted text-center" style="padding:20px;">No session data for ' + dateStr + '</p>';
    return;
  }

  // Sort
  if (sortBy === 'duration') sessions.sort((a, b) => (b.duration || 0) - (a.duration || 0));
  else if (sortBy === 'pages') sessions.sort((a, b) => (b.pages || 0) - (a.pages || 0));
  else sessions.sort((a, b) => (b.endedAt || '').localeCompare(a.endedAt || ''));

  let html = '<div class="session-list">';
  sessions.slice(0, 50).forEach(s => {
    const deviceIcon = s.device === 'mobile' ? 'ğŸ“±' : s.device === 'tablet' ? 'ğŸ“Ÿ' : 'ğŸ–¥ï¸';
    html += '<div class="session-card">';
    html += '<div style="font-size:1.5rem;">' + deviceIcon + '</div>';
    html += '<div class="session-meta">';
    html += '<div class="sm-item"><div class="sm-label">Visitor</div><div class="sm-val"><code style="color:var(--gold);font-size:0.8rem;">' + truncateId(s.visitorId || s.id) + '</code></div></div>';
    html += '<div class="sm-item"><div class="sm-label">Duration</div><div class="sm-val">' + formatDuration(s.duration) + '</div></div>';
    html += '<div class="sm-item"><div class="sm-label">Pages</div><div class="sm-val">' + (s.pages || 0) + '</div></div>';
    html += '<div class="sm-item"><div class="sm-label">Device</div><div class="sm-val">' + (s.device || 'unknown') + '</div></div>';
    html += '<div class="sm-item"><div class="sm-label">Ended</div><div class="sm-val">' + formatDateTime(s.endedAt) + '</div></div>';
    html += '</div>';
    html += '</div>';
  });
  html += '</div>';
  if (sessions.length > 50) {
    html += '<p class="text-muted text-center mt-16">Showing 50 of ' + sessions.length + ' sessions</p>';
  }
  container.innerHTML = html;
}
window.renderSessions = renderSessions;


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   5u. A/B TESTING
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function getActiveExperiments() {
  try {
    const raw = localStorage.getItem('mm_experiments');
    return raw ? JSON.parse(raw) : [];
  } catch { return []; }
}

function saveActiveExperiments(list) {
  localStorage.setItem('mm_experiments', JSON.stringify(list));
}

function addExperiment() {
  const input = document.getElementById('ab-new-name');
  const name = (input.value || '').trim().toLowerCase().replace(/[^a-z0-9-]/g, '-');
  if (!name) return;
  const list = getActiveExperiments();
  if (!list.includes(name)) {
    list.push(name);
    saveActiveExperiments(list);
  }
  input.value = '';
  renderABTesting();
}
window.addExperiment = addExperiment;

function removeExperiment(name) {
  const list = getActiveExperiments().filter(n => n !== name);
  saveActiveExperiments(list);
  renderABTesting();
}
window.removeExperiment = removeExperiment;

async function fetchABData() {
  if (!firebaseReady) return {};
  const snap = await fbRef('/abTests/').once('value');
  return snap.val() || {};
}

async function renderABTesting() {
  const activeList = getActiveExperiments();
  const activeEl = document.getElementById('ab-active-list');
  const resultsEl = document.getElementById('ab-results');

  // Active experiments list
  if (activeList.length === 0) {
    activeEl.innerHTML = '<p class="text-muted" style="font-size:0.85rem;">No active experiments. Add one above to start A/B testing.</p>';
  } else {
    let html = '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
    activeList.forEach(name => {
      html += '<span style="background:var(--bg);border:1px solid var(--border);border-radius:20px;padding:6px 14px;font-size:0.85rem;display:inline-flex;align-items:center;gap:8px;">';
      html += 'ğŸ§ª ' + name;
      html += ' <button onclick="removeExperiment(\'' + name + '\')" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:1rem;line-height:1;" title="Remove">Ã—</button>';
      html += '</span>';
    });
    html += '</div>';
    activeEl.innerHTML = html;
  }

  // Results from Firebase
  const abData = await fetchABData();
  const experiments = Object.keys(abData);

  if (experiments.length === 0) {
    resultsEl.innerHTML = '<p class="text-muted text-center" style="padding:20px;">No experiment data recorded yet. Once visitors are assigned variants, results will appear here.</p>';
    return;
  }

  let html = '<div class="ab-grid">';
  experiments.forEach(name => {
    const exp = abData[name] || {};
    const aViews = exp.A?.views || 0;
    const bViews = exp.B?.views || 0;
    const total = aViews + bViews;
    const aPct = total > 0 ? ((aViews / total) * 100).toFixed(1) : '50.0';
    const bPct = total > 0 ? ((bViews / total) * 100).toFixed(1) : '50.0';

    let winner = '';
    if (total >= 100) {
      if (aViews > bViews * 1.1) winner = 'ğŸ† Variant A is leading';
      else if (bViews > aViews * 1.1) winner = 'ğŸ† Variant B is leading';
      else winner = 'âš–ï¸ Too close to call';
    } else {
      winner = 'ğŸ“Š Need more data (' + total + '/100 views)';
    }

    const isActive = activeList.includes(name);

    html += '<div class="ab-card">';
    html += '<div class="ab-name">ğŸ§ª ' + name + (isActive ? ' <span style="color:var(--green);font-size:0.75rem;">â— ACTIVE</span>' : '') + '</div>';
    html += '<div class="ab-variants">';
    html += '<div class="ab-variant"><div class="ab-variant-label">Variant A</div><div class="ab-variant-value a">' + formatNumber(aViews) + '</div><div style="font-size:0.78rem;color:var(--text-dim);">' + aPct + '% of traffic</div></div>';
    html += '<div class="ab-variant"><div class="ab-variant-label">Variant B</div><div class="ab-variant-value b">' + formatNumber(bViews) + '</div><div style="font-size:0.78rem;color:var(--text-dim);">' + bPct + '% of traffic</div></div>';
    html += '</div>';
    html += '<div class="ab-winner">' + winner + '</div>';
    html += '</div>';
  });
  html += '</div>';
  resultsEl.innerHTML = html;
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   5v. REVENUE ESTIMATOR
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

async function calculateRevenue() {
  const resultsEl = document.getElementById('rev-results');
  const convRate = parseFloat(document.getElementById('rev-conv-rate').value) || 0;
  const aov = parseFloat(document.getElementById('rev-aov').value) || 0;
  const repeatRate = parseFloat(document.getElementById('rev-repeat').value) || 0;

  // Fetch traffic data
  const history = await fetchTrafficHistory(30);
  const dates = Object.keys(history).sort();
  const values = dates.map(d => history[d]);
  const totalPV = values.reduce((a, b) => a + b, 0);
  const dailyAvg = dates.length > 0 ? totalPV / dates.length : 0;

  // Calculations
  const dailyOrders = dailyAvg * (convRate / 100);
  const dailyRevenue = dailyOrders * aov;
  const monthlyRevenue = dailyRevenue * 30;
  const yearlyRevenue = monthlyRevenue * 12;
  const repeatBonus = yearlyRevenue * (repeatRate / 100);
  const yearlyTotal = yearlyRevenue + repeatBonus;

  // Render result cards
  let html = '';
  html += '<div class="rev-card"><div class="rev-label">Daily Traffic</div><div class="rev-value" style="color:var(--blue);">' + Math.round(dailyAvg) + '</div><div class="rev-sub">avg pageviews</div></div>';
  html += '<div class="rev-card"><div class="rev-label">Daily Orders</div><div class="rev-value" style="color:var(--gold);">' + dailyOrders.toFixed(1) + '</div><div class="rev-sub">at ' + convRate + '% conv.</div></div>';
  html += '<div class="rev-card"><div class="rev-label">Monthly Revenue</div><div class="rev-value" style="color:var(--green);">$' + formatNumber(Math.round(monthlyRevenue)) + '</div><div class="rev-sub">$' + Math.round(dailyRevenue) + '/day</div></div>';
  html += '<div class="rev-card"><div class="rev-label">Yearly Revenue</div><div class="rev-value" style="color:var(--pink);">$' + formatNumber(Math.round(yearlyTotal)) + '</div><div class="rev-sub">inc. ' + repeatRate + '% repeat</div></div>';
  resultsEl.innerHTML = html;

  // Revenue projection chart (30 days)
  if (dates.length > 0) {
    const projLabels = dates.map(d => { const p = d.split('-'); return p[1] + '/' + p[2]; });
    const revenueData = values.map(v => Math.round(v * (convRate / 100) * aov));
    const cumulative = [];
    revenueData.reduce((acc, v, i) => { cumulative.push(acc + v); return acc + v; }, 0);

    createChart('chart-revenue', 'line', {
      labels: projLabels,
      datasets: [
        {
          label: 'Daily Est. Revenue',
          data: revenueData,
          borderColor: '#7A9D54',
          backgroundColor: 'rgba(122, 157, 84, 0.1)',
          fill: true, tension: 0.4, borderWidth: 2, yAxisID: 'y'
        },
        {
          label: 'Cumulative Revenue',
          data: cumulative,
          borderColor: '#D4A574',
          borderDash: [6, 3],
          tension: 0.4, borderWidth: 2, yAxisID: 'y1', pointRadius: 0
        }
      ]
    }, {
      scales: {
        y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Daily ($)', color: '#556677' } },
        y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Cumulative ($)', color: '#556677' } }
      }
    });
  }
}
window.calculateRevenue = calculateRevenue;


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   5w. QUICK ACTIONS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function renderQuickActions() {
  const actions = [
    {
      icon: 'ğŸ”„', title: 'Trigger Product Sync',
      desc: 'Dispatch sync-products workflow',
      action: async (card) => {
        card.classList.add('running');
        card.querySelector('.action-status').innerHTML = '<span class="spinner"></span> Triggeringâ€¦';
        try {
          const resp = await fetch('https://api.github.com/repos/magnetmomentsco/magnetmomentsco.github.io/actions/workflows/sync-products.yml/dispatches', {
            method: 'POST',
            headers: { 'Accept': 'application/vnd.github+json' },
            body: JSON.stringify({ ref: 'main' })
          });
          if (resp.status === 204 || resp.ok) {
            card.querySelector('.action-status').innerHTML = '<span class="success">âœ… Triggered!</span>';
            logAction('Product sync workflow triggered');
          } else {
            throw new Error('HTTP ' + resp.status + ' â€” needs a PAT with workflow scope');
          }
        } catch (err) {
          card.querySelector('.action-status').innerHTML = '<span class="error">âŒ ' + err.message + '</span>';
        }
        card.classList.remove('running');
      }
    },
    {
      icon: 'ğŸš€', title: 'Trigger Deploy',
      desc: 'Dispatch deploy-pages workflow',
      action: async (card) => {
        card.classList.add('running');
        card.querySelector('.action-status').innerHTML = '<span class="spinner"></span> Triggeringâ€¦';
        try {
          const resp = await fetch('https://api.github.com/repos/magnetmomentsco/magnetmomentsco.github.io/actions/workflows/deploy-pages.yml/dispatches', {
            method: 'POST',
            headers: { 'Accept': 'application/vnd.github+json' },
            body: JSON.stringify({ ref: 'main' })
          });
          if (resp.status === 204 || resp.ok) {
            card.querySelector('.action-status').innerHTML = '<span class="success">âœ… Triggered!</span>';
            logAction('Deploy workflow triggered');
          } else {
            throw new Error('HTTP ' + resp.status + ' â€” needs a PAT with workflow scope');
          }
        } catch (err) {
          card.querySelector('.action-status').innerHTML = '<span class="error">âŒ ' + err.message + '</span>';
        }
        card.classList.remove('running');
      }
    },
    {
      icon: 'ğŸ§¹', title: 'Clear Local Cache',
      desc: 'Clear localStorage & sessionStorage',
      action: (card) => {
        const keysRemoved = Object.keys(localStorage).length + Object.keys(sessionStorage).length;
        localStorage.clear();
        sessionStorage.clear();
        card.querySelector('.action-status').innerHTML = '<span class="success">âœ… Cleared ' + keysRemoved + ' keys</span>';
        logAction('Local storage cleared (' + keysRemoved + ' keys)');
      }
    },
    {
      icon: 'ğŸ“Š', title: 'Export Analytics CSV',
      desc: 'Download today\'s pageview data',
      action: async (card) => {
        card.classList.add('running');
        if (!firebaseReady) {
          card.querySelector('.action-status').innerHTML = '<span class="error">âŒ Firebase not ready</span>';
          card.classList.remove('running');
          return;
        }
        try {
          const today = getToday();
          const snap = await fbRef('/pageViews/' + today).once('value');
          const data = snap.val() || {};
          let csv = 'Page,Timestamp,Referrer,Source,Device\n';
          Object.entries(data).forEach(([slug, entries]) => {
            if (typeof entries === 'object') {
              Object.values(entries).forEach(e => {
                csv += '"' + slug + '","' + (e.timestamp || '') + '","' + (e.referrer || '') + '","' + (e.source || '') + '","' + (e.device || '') + '"\n';
              });
            }
          });
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'analytics-' + today + '.csv';
          a.click();
          URL.revokeObjectURL(url);
          card.querySelector('.action-status').innerHTML = '<span class="success">âœ… Downloaded!</span>';
          logAction('Exported analytics CSV for ' + today);
        } catch (err) {
          card.querySelector('.action-status').innerHTML = '<span class="error">âŒ ' + err.message + '</span>';
        }
        card.classList.remove('running');
      }
    },
    {
      icon: 'ğŸ”', title: 'Run SEO Audit',
      desc: 'Re-check all pages for SEO issues',
      action: async (card) => {
        card.classList.add('running');
        card.querySelector('.action-status').innerHTML = '<span class="spinner"></span> Auditingâ€¦';
        await renderSEOHealth();
        card.querySelector('.action-status').innerHTML = '<span class="success">âœ… Audit complete</span>';
        card.classList.remove('running');
        logAction('SEO audit re-run');
        document.getElementById('section-seo').scrollIntoView({ behavior: 'smooth' });
      }
    },
    {
      icon: 'ğŸ’¾', title: 'Check DB Storage',
      desc: 'Refresh storage usage estimate',
      action: async (card) => {
        card.classList.add('running');
        card.querySelector('.action-status').innerHTML = '<span class="spinner"></span> Checkingâ€¦';
        await renderStorageManager();
        card.querySelector('.action-status').innerHTML = '<span class="success">âœ… Updated!</span>';
        card.classList.remove('running');
        logAction('Storage check refreshed');
      }
    }
  ];

  let html = '';
  actions.forEach((a, i) => {
    html += '<div class="action-card" id="action-card-' + i + '" onclick="runAction(' + i + ')">';
    html += '<div class="action-icon">' + a.icon + '</div>';
    html += '<div class="action-title">' + a.title + '</div>';
    html += '<div class="action-desc">' + a.desc + '</div>';
    html += '<div class="action-status"></div>';
    html += '</div>';
  });
  document.getElementById('actions-grid').innerHTML = html;

  // Store action handlers
  window._quickActions = actions;
}

function runAction(index) {
  const action = window._quickActions[index];
  const card = document.getElementById('action-card-' + index);
  if (action && card && !card.classList.contains('running')) {
    action.action(card);
  }
}
window.runAction = runAction;

function logAction(msg) {
  const log = document.getElementById('action-log');
  const time = new Date().toLocaleTimeString();
  log.innerHTML = '<div style="padding:2px 0;">[' + time + '] ' + msg + '</div>' + log.innerHTML;
}


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   5x. DATABASE STORAGE MANAGER
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

const FB_FREE_TIER_MB = 1024; // 1 GB

// Estimate JSON size of a Firebase snapshot
function estimateJsonSize(val) {
  if (val === null || val === undefined) return 0;
  try {
    return new Blob([JSON.stringify(val)]).size;
  } catch {
    return JSON.stringify(val).length;
  }
}

async function fetchStorageEstimates() {
  if (!firebaseReady) return [];

  const paths = [
    { path: '/pageViews/', label: 'ğŸ“„ Page Views', prunable: true },
    { path: '/presence/', label: 'ğŸ‘¥ Presence', prunable: false },
    { path: '/scrollDepth/', label: 'ğŸ“œ Scroll Depth', prunable: true },
    { path: '/clicks/', label: 'ğŸ–±ï¸ Clicks', prunable: true },
    { path: '/rageClicks/', label: 'ğŸ˜¤ Rage Clicks', prunable: true },
    { path: '/funnel/', label: 'ğŸ”„ Funnel', prunable: true },
    { path: '/newsletter/', label: 'ğŸ’Œ Newsletter', prunable: true },
    { path: '/visitors/', label: 'ğŸ¯ Visitors', prunable: false },
    { path: '/cart/', label: 'ğŸ›’ Cart', prunable: true },
    { path: '/performance/', label: 'âš¡ Performance', prunable: true },
    { path: '/errors/', label: 'ğŸ› Errors', prunable: true },
    { path: '/abTests/', label: 'ğŸ§ª A/B Tests', prunable: false },
    { path: '/sessions/', label: 'ğŸ¥ Sessions', prunable: true },
    { path: '/productViewCounts/', label: 'ğŸ·ï¸ Product Views', prunable: true },
    { path: '/events/', label: 'ğŸ“¡ Custom Events', prunable: true }
  ];

  const results = [];
  const promises = paths.map(async (p) => {
    try {
      const snap = await fbRef(p.path).once('value');
      const val = snap.val();
      const bytes = val ? estimateJsonSize(val) : 0;
      const dateKeys = val && typeof val === 'object' ? Object.keys(val).filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k)).sort() : [];
      results.push({ ...p, bytes, dateKeys, hasData: val !== null });
    } catch {
      results.push({ ...p, bytes: 0, dateKeys: [], hasData: false });
    }
  });

  await Promise.all(promises);
  return results.sort((a, b) => b.bytes - a.bytes);
}

function formatBytes(bytes) {
  if (bytes === 0) return '0 B';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

async function renderStorageManager() {
  const breakdownEl = document.getElementById('storage-breakdown');
  const fillEl = document.getElementById('storage-fill');
  const totalEl = document.getElementById('storage-total');
  const alertEl = document.getElementById('storage-alert');
  const badgeEl = document.getElementById('storage-badge');

  if (!firebaseReady) {
    breakdownEl.innerHTML = '<p class="text-muted text-center">Firebase not configured â€” cannot estimate storage.</p>';
    return;
  }

  const estimates = await fetchStorageEstimates();
  const totalBytes = estimates.reduce((a, e) => a + e.bytes, 0);
  const totalMB = totalBytes / (1024 * 1024);
  const pct = Math.min((totalMB / FB_FREE_TIER_MB) * 100, 100);

  // Gauge
  fillEl.style.width = Math.max(pct, 2) + '%';
  fillEl.textContent = pct.toFixed(1) + '%';
  fillEl.className = 'storage-gauge-fill ' + (pct < 60 ? 'green' : pct < 85 ? 'yellow' : 'red');
  totalEl.textContent = formatBytes(totalBytes) + ' / 1,024 MB';

  // Alert
  if (pct >= 85) {
    alertEl.style.display = 'block';
    alertEl.innerHTML = '<strong>âš ï¸ Storage Warning!</strong><p style="margin-top:8px;">Database is at ' + pct.toFixed(1) + '% capacity. Consider pruning old data or upgrading your Firebase plan.</p>';
    badgeEl.style.display = '';
    badgeEl.textContent = '!';

    // Auto-prune if enabled
    const pruneEnabled = document.getElementById('prune-enabled').checked;
    if (pruneEnabled) {
      const days = parseInt(document.getElementById('prune-days').value) || 30;
      await pruneOldData(days, true);
    }
  } else {
    alertEl.style.display = 'none';
    badgeEl.style.display = 'none';
  }

  // Breakdown table
  let html = '';
  estimates.forEach(e => {
    html += '<div class="storage-row">';
    html += '<div class="sr-path">' + e.label + '</div>';
    html += '<div style="display:flex;align-items:center;gap:12px;">';
    html += '<span class="sr-size">' + formatBytes(e.bytes) + '</span>';
    if (e.prunable && e.dateKeys.length > 0) {
      html += '<span style="font-size:0.75rem;color:var(--text-dim);">(' + e.dateKeys.length + ' days)</span>';
    }
    html += '</div>';
    html += '</div>';
  });

  if (totalBytes === 0) {
    html = '<p class="text-muted text-center" style="padding:20px;">Database is empty â€” no data stored yet.</p>';
  }

  breakdownEl.innerHTML = html;
  loadAutoprune();
}

// Auto-prune config
function loadAutoprune() {
  try {
    const config = JSON.parse(localStorage.getItem('mm_autoprune') || '{}');
    document.getElementById('prune-enabled').checked = config.enabled || false;
    document.getElementById('prune-days').value = config.days || 30;
  } catch {}
}

function saveAutoprune() {
  const config = {
    enabled: document.getElementById('prune-enabled').checked,
    days: parseInt(document.getElementById('prune-days').value) || 30
  };
  localStorage.setItem('mm_autoprune', JSON.stringify(config));
}
window.saveAutoprune = saveAutoprune;

async function pruneOldData(daysToKeep, isAuto) {
  if (!firebaseReady) return;

  const statusEl = document.getElementById('prune-status');
  const btnEl = document.getElementById('btn-prune');
  btnEl.disabled = true;
  statusEl.textContent = (isAuto ? 'ğŸ”„ Auto-pruning' : 'ğŸ”„ Pruning') + 'â€¦';

  const cutoffDate = getDateOffset(daysToKeep);
  const prunablePaths = [
    '/pageViews/', '/scrollDepth/', '/clicks/', '/rageClicks/',
    '/funnel/', '/newsletter/', '/cart/', '/performance/',
    '/errors/', '/sessions/', '/productViewCounts/', '/events/'
  ];

  let totalRemoved = 0;
  const prunePromises = prunablePaths.map(async (path) => {
    try {
      const snap = await fbRef(path).once('value');
      const data = snap.val();
      if (!data || typeof data !== 'object') return;

      const dateKeys = Object.keys(data).filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k));
      const oldKeys = dateKeys.filter(k => k < cutoffDate);

      for (const key of oldKeys) {
        await fbRef(path + key).remove();
        totalRemoved++;
      }
    } catch (err) {
      console.warn('Prune error for ' + path + ':', err);
    }
  });

  await Promise.all(prunePromises);

  statusEl.textContent = 'âœ… Removed ' + totalRemoved + ' old date entries (before ' + cutoffDate + ')';
  btnEl.disabled = false;

  if (totalRemoved > 0) {
    logAction((isAuto ? 'Auto-pruned' : 'Manually pruned') + ' ' + totalRemoved + ' old date entries');
    // Refresh storage display
    setTimeout(() => renderStorageManager(), 1000);
  }
}

async function runManualPrune() {
  const days = parseInt(document.getElementById('prune-days').value) || 30;
  if (!confirm('Delete all analytics data older than ' + days + ' days? This cannot be undone.')) return;
  await pruneOldData(days, false);
}
window.runManualPrune = runManualPrune;


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   6. SECTION COLLAPSE TOGGLE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function toggleSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (!section) return;
  section.classList.toggle('collapsed');
  const header = section.querySelector('.section-header');
  if (header) header.classList.toggle('open');
}
window.toggleSection = toggleSection;


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   7. INITIALIZATION
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

async function initDashboard() {
  renderTopBar();
  renderQuickLinks();
  renderQuickActions();
  loadSocialProofConfig();

  // Firebase is already initialized before auth flow
  const fbOk = firebaseReady;

  // Fire all renderers concurrently
  const renderers = [
    renderQuickStats(),
    renderTrafficChart(),
    renderTrafficSources(),
    renderScrollDepth(),
    renderClickHeatmapPageList(),
    renderFunnel(),
    renderNewsletter(),
    renderIntent(),
    renderCartAnalytics(),
    renderPerformance(),
    renderSEOHealth(),
    renderErrors(),
    renderDeployments(),
    renderInventory(),
    renderSocialProofPreview(),
    renderSessions(),
    renderABTesting(),
    calculateRevenue(),
    renderStorageManager()
  ];

  // Subscribe to live visitors (real-time)
  if (fbOk) {
    subscribeLiveVisitors(renderLiveVisitors);
  } else {
    document.getElementById('live-visitors-content').innerHTML =
      '<p class="text-muted text-center" style="padding:20px;">Firebase not configured â€” live visitor data unavailable</p>';
  }

  // Settle all renderers (don't let one failure break others)
  await Promise.allSettled(renderers);
}

// Initialize Firebase on load â€” auth state listener handles the rest
initFirebase();

})();
</script>
</body>
</html>
